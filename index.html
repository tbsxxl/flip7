<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flip 7 – Score Tracker</title>

<style>
body{
 font-family:system-ui,Arial;
 background:#f6f7f9;
 margin:0;
 padding:16px;
 color:#1a1a1a;
}

h1{text-align:center;margin-bottom:20px;}

#ranking{
 background:white;
 border-radius:14px;
 padding:14px;
 margin-bottom:18px;
 box-shadow:0 3px 10px rgba(0,0,0,.06);
}

.rank-head{
 display:flex;
 align-items:center;
 justify-content:space-between;
 gap:12px;
 margin-bottom:10px;
}
.badge{
 background:#eef1f5;
 border-radius:999px;
 padding:6px 10px;
 font-weight:700;
 font-size:.9rem;
 white-space:nowrap;
}

/* Ranking Farbe */
.rank-row{
 display:flex;
 align-items:center;
 gap:8px;
}
.rank-dot{
 width:12px;
 height:12px;
 border-radius:50%;
}

/* Spieler */
.player-box{
 background:white;
 border-radius:14px;
 padding:14px;
 margin-bottom:14px;
 border-left:6px solid #ccc;
 box-shadow:0 2px 6px rgba(0,0,0,.05);
 transition:.35s;
 position:relative;
}

.player-box.leader{
 transform:scale(1.02);
 box-shadow:0 10px 25px rgba(0,0,0,.12);
}

.player-box.pulse{
 animation: leaderPulse 1.1s ease;
}
@keyframes leaderPulse{
 0%{ box-shadow:0 2px 6px rgba(0,0,0,.05); }
 50%{ box-shadow:0 0 0 6px rgba(34,197,94,.18), 0 18px 35px rgba(0,0,0,.14); }
 100%{ box-shadow:0 10px 25px rgba(0,0,0,.12); }
}

.player-box.bustFlash{
 animation:bustFlash .7s ease;
}
@keyframes bustFlash{
 0%{ background:#ffe3e3;}
 100%{ background:white;}
}

/* Floating Score */
.floatScore{
 position:absolute;
 right:20px;
 top:10px;
 font-weight:800;
 font-size:1.05rem;
 opacity:0;
 transform:translateY(0);
 animation:floatUp .9s ease forwards;
}
@keyframes floatUp{
 0%{opacity:0;transform:translateY(10px);}
 40%{opacity:1;}
 100%{opacity:0;transform:translateY(-30px);}
}

/* Progress */
.progress-container{
 background:#e7e9ed;
 height:12px;
 border-radius:6px;
 overflow:hidden;
 margin:8px 0;
}
.progress-bar{
 height:100%;
 transition:width .5s ease;
}

/* Cards */
.card-container{
 display:flex;
 flex-wrap:wrap;
 gap:8px;
 margin-top:6px;
}
.card{
 background:#eef1f5;
 padding:12px 16px;
 border-radius:10px;
 font-weight:700;
 cursor:pointer;
 min-width:44px;
 text-align:center;
}

/* Buttons */
button{
 padding:10px 16px;
 border-radius:10px;
 border:none;
 cursor:pointer;
 font-weight:600;
}
.green{background:#22c55e;color:white;}
.red{background:#ef4444;color:white;}
.ghost{background:#eef1f5;color:#111;}

/* Popup */
.overlay{
 display:none;
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.35);
 z-index:500;
}
.popup{
 display:none;
 position:fixed;
 top:8%;
 left:50%;
 transform:translateX(-50%);
 width:92%;
 max-width:520px;
 background:white;
 padding:22px;
 border-radius:18px;
 max-height:84%;
 overflow:auto;
 z-index:1000;
}

.selectedWrap{
 background:#f6f7f9;
 border-radius:12px;
 padding:10px;
 margin:10px 0 14px 0;
}
.selectedTitle{
 display:flex;
 align-items:center;
 justify-content:space-between;
 gap:10px;
 margin-bottom:8px;
 font-weight:800;
}
.chips{
 display:flex;
 flex-wrap:wrap;
 gap:8px;
}
.chip{
 background:white;
 border:1px solid #e2e6ee;
 border-radius:999px;
 padding:8px 10px;
 font-weight:800;
 cursor:pointer;
 user-select:none;
}
.hint{
 font-size:.9rem;
 color:#555;
 margin-top:6px;
}

/* Quick Add Row */
.quickRow{
 display:flex;
 gap:8px;
 margin-top:8px;
}
.quickRow input{
 flex:1;
 padding:10px 12px;
 border-radius:12px;
 border:1px solid #d7dbe4;
 font-weight:700;
 outline:none;
}
.quickRow button{
 white-space:nowrap;
}

/* Winner */
#winnerScreen{
 display:none;
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.6);
 justify-content:center;
 align-items:center;
 z-index:2000;
}
#winnerCard{
 background:white;
 padding:40px;
 border-radius:24px;
 text-align:center;
 box-shadow:0 25px 60px rgba(0,0,0,.25);
}

@media(max-width:600px){
 #numberCards,#modifierCards{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
 }
 .card{
  padding:16px 0;
  font-size:1.1rem;
 }
}
</style>
</head>

<body>

<h1>Flip 7 – Score Tracker</h1>

<div id="ranking"></div>

<div>
  <input id="playerName" placeholder="Spielername">
  <button class="green" onclick="addPlayer()">+</button>
</div>

<div id="targetRow" style="margin:12px 0;">
  Spielziel:
  <input type="number" id="targetPoints" value="200">
</div>

<div id="playersContainer"></div>

<button class="green" style="width:100%" onclick="endRound()">Zwischenrunde beenden</button>

<h3>Statistik</h3>
<div id="stats"></div>

<div class="overlay" id="overlay" onclick="closePopup(true)"></div>

<div class="popup" id="popup">
  <h3 id="popupTitle"></h3>

  <div class="selectedWrap">
    <div class="selectedTitle">
      <span>Ausgewählt (zum Entfernen antippen)</span>
      <button class="ghost" onclick="clearPopupSelection()">Leeren</button>
    </div>
    <div id="selectedChips" class="chips"></div>
    <div id="popupLiveInfo" class="hint"></div>
  </div>

  <!-- NEU: Freie Punkteeingabe -->
  <div class="quickRow">
    <input id="freeScoreInput" type="number" placeholder="Punkte direkt eingeben (z.B. 37)">
    <button class="green" onclick="applyFreeScore()">Übernehmen</button>
  </div>
  <div class="hint">Diese Eingabe setzt die Runde direkt auf die Punktzahl (ignoriert Karten/Bust).</div>

  <h4 style="margin-top:18px;">Zahlen</h4>
  <div id="numberCards" class="card-container"></div>

  <h4>Modifier</h4>
  <div id="modifierCards" class="card-container"></div>

  <button class="red" style="width:100%; margin-top:12px;" onclick="closePopup(false)">Fertig</button>
</div>

<div id="winnerScreen">
 <div id="winnerCard">
  <h2 id="winnerText"></h2>
  <button class="green" onclick="resetGame()">Neues Spiel</button>
 </div>
</div>

<script>
let players=[];
let selectedPlayer=null;

let gameLocked=false;
let prevLeaderIndex=null;

const palette=[
 "#2563eb","#16a34a","#ea580c","#9333ea",
 "#0ea5e9","#dc2626","#14b8a6","#eab308"
];

const numbers=[...Array(13).keys()];
const modifiers=["+2","+4","+6","+8","+10","x2"];

let popupCards=[];
let popupManualOverride=null; // NEU: freie Punkteeingabe

numbers.forEach(n=>{
  let d=document.createElement("div");
  d.className="card";
  d.innerText=n;
  d.onclick=()=>popupAdd(n);
  numberCards.appendChild(d);
});
modifiers.forEach(m=>{
  let d=document.createElement("div");
  d.className="card";
  d.innerText=m;
  d.onclick=()=>popupAdd(m);
  modifierCards.appendChild(d);
});

function scoreFromCards(cards){
  const nums = cards.filter(c=>typeof c==="number");
  const mods = cards.filter(c=>typeof c==="string");

  // Bust: keine Zahlen oder doppelte Zahlen
  const isBust = (nums.length===0) || (new Set(nums).size !== nums.length);
  if(isBust) return { score:0, isBust:true, numbersCount: nums.length };

  const sumNums = nums.reduce((a,b)=>a+b,0);

  // x2 zählt nur auf Zahlen (falls mehrere x2 → stapeln)
  let multi = 1;
  for(const m of mods){
    if(m==="x2") multi *= 2;
  }

  // Modifier (+2..+10) addieren (nicht verdoppeln)
  let modSum = 0;
  for(const m of mods){
    if(m.startsWith("+")) modSum += Number(m.slice(1));
  }

  // Bonus +15 bei genau 7 Zahlen (nicht verdoppeln)
  const bonus = (nums.length===7) ? 15 : 0;

  // WICHTIG: erst Zahlen*x2, dann +Modifier +Bonus
  const score = (sumNums * multi) + modSum + bonus;

  return { score, isBust:false, numbersCount: nums.length };
}


function addPlayer(){
  const name = playerName.value.trim();
  if(!name) return;

  players.push({
    name,
    color: palette[players.length % palette.length],
    cards:[],
    total:0,
    rounds:[],
    busts:0,
    lastScore:null,
    lastBust:false,
    overrideScore:null
  });

  playerName.value="";
  renderAll();
}

function openPopup(i){
  selectedPlayer=i;
  popupCards = [...players[i].cards];
  popupManualOverride = players[i].overrideScore;
  popup.style.display="block";
  overlay.style.display="block";
  popupTitle.innerText="Karten für "+players[i].name;

  freeScoreInput.value = popupManualOverride !== null ? popupManualOverride : "";
  renderPopupSelection();
}

function closePopup(cancel){
  popup.style.display="none";
  overlay.style.display="none";

  if(!cancel && selectedPlayer!==null){
    players[selectedPlayer].cards = [...popupCards];
    players[selectedPlayer].overrideScore = popupManualOverride;
  }

  selectedPlayer=null;
  renderAll();
}

function popupAdd(card){
  popupCards.push(card);
  popupManualOverride = null;
  freeScoreInput.value="";
  renderPopupSelection();
}

function popupRemoveAt(index){
  popupCards.splice(index,1);
  popupManualOverride = null;
  freeScoreInput.value="";
  renderPopupSelection();
}

function clearPopupSelection(){
  popupCards = [];
  popupManualOverride = null;
  freeScoreInput.value="";
  renderPopupSelection();
}

function applyFreeScore(){
  let val = Number(freeScoreInput.value);
  if(!Number.isFinite(val) || val < 0) return;
  popupManualOverride = Math.floor(val);
  renderPopupSelection();
}

function renderPopupSelection(){
  selectedChips.innerHTML = "";

  if(popupCards.length===0){
    selectedChips.innerHTML = `<span class="hint">Keine Karten ausgewählt.</span>`;
  }else{
    popupCards.forEach((c, idx)=>{
      const chip = document.createElement("div");
      chip.className="chip";
      chip.textContent = String(c);
      chip.onclick = ()=>popupRemoveAt(idx);
      selectedChips.appendChild(chip);
    });
  }

  if(popupManualOverride !== null){
    popupLiveInfo.textContent = `Vorschau: ${popupManualOverride} Punkte (manuell)`;
    return;
  }

  const preview = scoreFromCards(popupCards);
  const bustTxt = preview.isBust ? "BUST (0 Punkte)" : `${preview.score} Punkte`;
  const bonusTxt = (!preview.isBust && preview.numbersCount===7) ? " • +15 Bonus aktiv" : "";
  popupLiveInfo.textContent = `Vorschau: ${bustTxt}${bonusTxt}`;
}

function removeCard(playerIndex, cardIndex){
  players[playerIndex].cards.splice(cardIndex,1);
  players[playerIndex].overrideScore = null;
  renderAll();
}

function renderRanking(){
  const target = Number(targetPoints.value)||200;

  const list = [...players].map(p=>{
    const live = (p.overrideScore !== null) ? p.overrideScore : scoreFromCards(p.cards).score;
    return { name:p.name, color:p.color, score:p.total + live };
  }).sort((a,b)=>b.score-a.score);

  const goal = `<span class="badge">Ziel: ${target}</span>`;
  ranking.innerHTML = `
    <div class="rank-head">
      <strong>Führung</strong>
      ${goal}
    </div>
    ${list.map((p,i)=>`
      <div class="rank-row">
        ${i+1}.
        <div class="rank-dot" style="background:${p.color}"></div>
        ${p.name} – ${p.score}
      </div>
    `).join("")}
  `;
}

function getLeader(){
  let best=-1,score=-Infinity;
  players.forEach((p,i)=>{
    const live = (p.overrideScore !== null) ? p.overrideScore : scoreFromCards(p.cards).score;
    const s = p.total + live;
    if(s>score){score=s;best=i;}
  });
  return best;
}

function renderPlayers(){
  playersContainer.innerHTML="";
  const leader = getLeader();
  const target = Number(targetPoints.value)||200;

  const leaderChanged = (prevLeaderIndex !== null && leader !== prevLeaderIndex);
  prevLeaderIndex = leader;

  players.forEach((p,i)=>{
    const res = (p.overrideScore !== null)
      ? { score:p.overrideScore, isBust:(p.overrideScore===0), numbersCount:0 }
      : scoreFromCards(p.cards);

    const live = res.score;
    const total = p.total + live;

    const div = document.createElement("div");
    div.className="player-box";
    if(i===leader) div.classList.add("leader");
    div.style.borderLeftColor = p.color;

    if(i===leader && leaderChanged){
      div.classList.add("pulse");
      setTimeout(()=>div.classList.remove("pulse"), 1200);
    }

    if(p.lastScore !== null && p.lastBust){
      div.classList.add("bustFlash");
      setTimeout(()=>div.classList.remove("bustFlash"), 750);
    }

    const floatText = (p.lastScore===null)
      ? ""
      : `<div class="floatScore">${p.lastBust ? "BUST" : "+"+p.lastScore}</div>`;

    const cardsHTML = p.cards.map((c, idx)=>`
      <div class="card" onclick="removeCard(${i},${idx})">${c}</div>
    `).join("");

let hint = "";
if(p.cards.length > 0){ 
  hint = res.isBust
    ? `<span style="font-weight:800;color:#b91c1c">BUST</span>`
    : (res.numbersCount===7 ? `<span style="font-weight:800;color:#166534">+15 Bonus</span>` : "");
}


    const overrideHint = (p.overrideScore !== null)
      ? `<span class="badge">manuell</span>`
      : "";

    div.innerHTML = `
      <strong>${p.name}</strong> ${hint} ${overrideHint}
      ${floatText}
      <div class="progress-container">
        <div class="progress-bar" style="width:${Math.min((target? (total/target*100):0),100)}%; background:${p.color}"></div>
      </div>
      Runde: ${live} | Gesamt: ${total}
      <div class="card-container">${cardsHTML}</div>
      <button class="green" style="width:100%" onclick="openPopup(${i})">Karte hinzufügen</button>
    `;

    playersContainer.appendChild(div);
  });
}

function renderStats(){
  let html="";
  players.forEach(p=>{
    const avg = (p.rounds.reduce((a,b)=>a+b,0) / (p.rounds.length||1)).toFixed(1);
    const bustQuote = p.rounds.length ? Math.round((p.busts/p.rounds.length)*100) : 0;
    html += `${p.name}: Ø ${avg} • Bust-Quote: ${bustQuote}% (${p.busts}/${p.rounds.length})<br>`;
  });
  stats.innerHTML = html || "Noch keine Daten";
}

function showWinner(name){
  winnerText.innerText = name+" gewinnt!";
  winnerScreen.style.display="flex";
}

function resetGame(){
  winnerScreen.style.display="none";
  players.forEach(p=>{
    p.total=0;
    p.cards=[];
    p.rounds=[];
    p.busts=0;
    p.lastScore=null;
    p.lastBust=false;
    p.overrideScore=null;
  });
  gameLocked=false;
  targetRow.style.display="block";
  renderAll();
}

function endRound(){
  const target = Number(targetPoints.value)||200;

  if(!gameLocked){
    gameLocked=true;
    targetRow.style.display="none";
  }

  players.forEach(p=>{
    let res;

    if(p.overrideScore !== null){
      res = { score:p.overrideScore, isBust:(p.overrideScore===0) };
    }else{
      res = scoreFromCards(p.cards);
    }

    const s = res.score;

    p.total += s;
    p.rounds.push(s);
    p.lastScore = s;
    p.lastBust = res.isBust;

    if(res.isBust) p.busts += 1;

    p.cards = [];
    p.overrideScore = null;
  });

  const win = players.find(p=>p.total >= target);

  renderAll();

  setTimeout(()=>{
    players.forEach(p=>{ p.lastScore=null; p.lastBust=false; });
    renderPlayers();
  }, 1000);

  if(win) showWinner(win.name);
}

function renderAll(){
  renderRanking();
  renderPlayers();
  renderStats();
}

renderAll();
</script>

</body>
</html>
