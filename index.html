<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Flip 7 â€“ Score Tracker</title>

<!-- PWA / iOS A2HS basics -->
<meta name="theme-color" content="#f6f7f9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
:root{
  /* Colors */
  --bg:#f6f7f9; --card:#fff; --muted:#eef1f5; --muted2:#dfe4ea;
  --text:#0f172a; --sub:#475569; --sub2:#64748b;
  --action:#937972;
  --mod:#f8b22d;
  --danger:#ef4444;

  /* Shadows */
  --sh1:0 1px 2px rgba(0,0,0,.06);
  --sh2:0 12px 28px rgba(0,0,0,.10);

  /* High-contrast borders */
  --hcBorder: rgba(15,23,42,.12);
  --hcInset: rgba(15,23,42,.18);

  /* Radii system */
  --rSheet:24px;
  --rCard:16px;
  --rBtn:14px;
  --rChip:12px;

  /* Typography scale (iOS-ish) */
  --fsTitle:18px;    /* 17â€“20 */
  --fsBody:16px;     /* 15â€“16 */
  --fsSecondary:13px;/* 13â€“14 */
  --wTitle:800;
  --wBody:700;
  --wSecondary:650;

  /* Dynamic bar alpha (set by JS) */
  --barAlpha:.92;

  /* iOS keyboard vh fix (set by JS) */
  --vh: 1vh;
}

/* High Contrast (Sonne) */
body.highContrast{
  --text:#0b1220;
  --sub:#334155;
  --sub2:#475569;
  --muted2:#c7ced8;
  --sh1:0 0 0 rgba(0,0,0,0);
  --sh2:0 0 0 rgba(0,0,0,0);
}

/* Compact Mode */
body.compact{ padding:10px; }
body.compact .player-box{ padding:10px; margin-bottom:8px; }
body.compact .progress-container{ height:7px; margin:6px 0; border-radius:5px; }
body.compact .card-container{ gap:4px; }
body.compact .cardchip{ padding:5px 8px; font-size:.82rem; }
body.compact #endRoundBtn{ padding:14px 12px; }
body.compact .plusBtn{ width:44px;height:44px;border-radius:14px; }
body.compact .rankItem{ padding:8px 10px; margin:6px 0; }
body.compact #leaderStrip{ padding:8px 10px; }
body.compact .badge{ padding:5px 8px; font-size:.84rem; }

*{-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  font-family: system-ui, -apple-system, Arial;
  margin:0;
  padding:14px;
  background:var(--bg);
  color:var(--text);
  font-variant-numeric: tabular-nums;
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  font-size: var(--fsBody);
  scroll-padding-bottom: calc(90px + env(safe-area-inset-bottom));
}
button,input{touch-action:manipulation}
h1{
  text-align:center;
  margin:8px 0 12px 0;
  font-size: 20px;
  font-weight: var(--wTitle);
  letter-spacing: .2px;
}

@media (prefers-reduced-motion: reduce){
  *{animation:none!important;transition:none!important;scroll-behavior:auto!important}
}

/* Topbar / Bottombar dynamic alpha */
#topbar{
  position:sticky; top:0; z-index:100;
  background: rgba(246,247,249,var(--barAlpha));
  backdrop-filter: blur(10px);
  padding: calc(8px + env(safe-area-inset-top)) 0 10px 0;
}
#bottomBar{
  position:sticky; bottom:0; z-index:90;
  background: rgba(246,247,249,var(--barAlpha));
  backdrop-filter: blur(12px);
  padding:10px 0 calc(10px + env(safe-area-inset-bottom)) 0;
}

#leaderStrip{
  background:var(--card);
  border-radius: var(--rCard);
  box-shadow: var(--sh1), var(--sh2);
  padding:10px 12px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  position:relative;
  overflow:visible;
}
body.highContrast #leaderStrip{ box-shadow:none; border:1px solid var(--hcBorder); }

/* Leader spotlight */
#leaderStrip.spotlight::after{
  content:"";
  position:absolute; inset:-40px;
  background:radial-gradient(circle at 25% 35%, rgba(34,197,94,.18), transparent 55%);
  animation:spotlight .6s ease forwards;
  pointer-events:none;
}
@keyframes spotlight{
  0%{opacity:0; transform:scale(.98)}
  35%{opacity:1}
  100%{opacity:0; transform:scale(1.02)}
}

#leaderLeft{display:flex;flex-direction:column;gap:6px;min-width:0}
#leaderLine{display:flex;align-items:center;gap:10px;min-width:0}
#leaderDot{width:12px;height:12px;border-radius:50%}
#leaderTextWrap{display:flex;align-items:center;gap:8px;min-width:0}
#leaderCrown{display:inline-flex;transform-origin:center}
#leaderCrown.pop{animation:crownPop .22s ease}
@keyframes crownPop{0%{transform:scale(.95);opacity:.75}100%{transform:scale(1);opacity:1}}

#leaderName{
  font-weight: var(--wTitle);
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  max-width:42vw;
  font-size: 16px;
}
#leaderScore{
  font-weight: var(--wTitle);
  font-size: 17px; /* score slightly dominates */
}
.crossfade{animation:crossfade .15s ease}
@keyframes crossfade{0%{opacity:.2}100%{opacity:1}}

#leaderHint{
  font-weight: var(--wSecondary);
  color: var(--sub);
  font-size: var(--fsSecondary);
  display:none
}
#subLine{display:flex;gap:8px;flex-wrap:wrap}
.badge{
  background:var(--muted);
  border-radius:999px;
  padding:6px 10px;
  font-weight: var(--wBody);
  font-size: var(--fsSecondary);
  letter-spacing:.2px;
  white-space:nowrap;
}

.iconBtn{
  background:var(--muted);
  border:none;
  border-radius:12px;
  padding:10px 12px;
  font-weight: var(--wBody);
  cursor:pointer;
  min-width:48px; min-height:48px;
}
.iconBtn:active{transform:scale(.98)}
.iconBtn[aria-expanded="true"]{box-shadow:inset 0 0 0 2px rgba(30,136,229,.25)}
body.highContrast .iconBtn{ box-shadow:inset 0 0 0 1px rgba(15,23,42,.14); }
body.highContrast .iconBtn:active{ box-shadow:inset 0 0 0 2px var(--hcInset); transform:scale(.99); }

#rankingPanel{
  margin-top:10px;
  background:var(--card);
  border-radius: var(--rCard);
  box-shadow: var(--sh1), 0 10px 25px rgba(0,0,0,.06);
  padding:0 12px;
  overflow:hidden;
  max-height:0;
  opacity:0;
  transform:translateY(-4px);
  transition:max-height .28s ease,opacity .22s ease,transform .22s ease,padding .22s ease;
}
#rankingPanel.open{padding:12px;max-height:560px;opacity:1;transform:translateY(0)}
body.highContrast #rankingPanel{ box-shadow:none; border:1px solid var(--hcBorder); }

.rankItem{
  border:1px solid rgba(15,23,42,.10);
  border-radius: var(--rBtn);
  padding:10px 12px;
  display:flex; align-items:center; gap:10px;
  margin:8px 0;
  box-shadow:0 1px 2px rgba(0,0,0,.04);
}
body.highContrast .rankItem{ box-shadow:none; }
.rankNo{font-weight: var(--wBody);width:26px;color:var(--sub)}
.rankDot{width:10px;height:10px;border-radius:50%}
.rankName{font-weight: var(--wBody);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rankScore{font-weight: var(--wTitle); font-size: 16px;} /* score dominates */

/* Tools menu (popover) */
#toolsMenu{
  position:fixed; z-index:100000;
  background:var(--card);
  border-radius: var(--rBtn);
  box-shadow: var(--sh2);
  padding:8px;
  display:none;
  min-width:240px;
  transform-origin:top right;
  border:1px solid rgba(15,23,42,.10);
}
body.highContrast #toolsMenu{ box-shadow:none; border:1px solid var(--hcBorder); }
#toolsMenu.open{display:block; animation:menuIn .12s ease}
@keyframes menuIn{0%{opacity:0;transform:scale(.98)}100%{opacity:1;transform:scale(1)}}

/* caret */
#toolsMenu::before{
  content:"";
  position:absolute;
  width:12px;height:12px;
  transform: rotate(45deg);
  top:-6px;
  right:18px;
  background: var(--card);
  border-left:1px solid rgba(15,23,42,.10);
  border-top:1px solid rgba(15,23,42,.10);
}
body.highContrast #toolsMenu::before{
  border-left:1px solid var(--hcBorder);
  border-top:1px solid var(--hcBorder);
}

.menuItem{
  width:100%;
  text-align:left;
  border:none;
  background:transparent;
  padding:12px 12px;
  border-radius:12px;
  font-weight: var(--wBody);
  cursor:pointer;
  min-height:48px;
  font-size: 15px;
}
.menuItem:active{background:rgba(15,23,42,.06)}
.menuItem.danger{color:#b91c1c}
.menuItem:disabled{opacity:.45;cursor:not-allowed}
.menuSep{height:1px;background:rgba(15,23,42,.10);margin:6px 0}

#targetRow{
  margin:10px 0;
  background:var(--card);
  border-radius: var(--rCard);
  box-shadow: var(--sh1), 0 10px 25px rgba(0,0,0,.06);
  padding:10px 12px;
  display:flex; align-items:center; gap:10px;
}
body.highContrast #targetRow{ box-shadow:none; border:1px solid var(--hcBorder); }
#targetRow strong{font-weight: var(--wBody)}
#targetPoints{
  flex:1; padding:10px 12px; border-radius:12px;
  border:1px solid #d7dbe4; font-weight: var(--wBody); outline:none;
}
body.highContrast #targetPoints{ border-color: rgba(15,23,42,.18); }

#emptyState{
  display:none;
  background:var(--card);
  border-radius: var(--rCard);
  box-shadow: var(--sh1), 0 10px 25px rgba(0,0,0,.06);
  padding:14px; margin-top:10px;
  font-weight: var(--wBody);
  color: var(--sub);
}
body.highContrast #emptyState{ box-shadow:none; border:1px solid var(--hcBorder); }

#playersContainer{margin-top:10px}

.player-box{
  background:var(--card);
  border-radius: var(--rCard);
  padding:12px;
  margin-bottom:10px;
  border-left:6px solid #ccc;
  box-shadow: var(--sh1), 0 10px 25px rgba(0,0,0,.06);
  position:relative;
}
body.highContrast .player-box{
  box-shadow:none;
  border:1px solid var(--hcBorder);
  border-left-width:6px;
}
.player-box.leader{box-shadow: var(--sh1), var(--sh2); transform:scale(1.01)}
body.highContrast .player-box.leader{ box-shadow:none; }

.player-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
.player-name{
  font-weight: var(--wBody);
  font-size: 16px;
  display:flex;align-items:center;gap:8px;min-width:0
}
.player-dot{width:10px;height:10px;border-radius:50%}
.miniBadge{
  background:var(--muted);
  border-radius:999px;
  padding:5px 8px;
  font-weight: var(--wBody);
  font-size: var(--fsSecondary);
  letter-spacing:.2px
}
.miniBadge.action{background:var(--action);color:#fff}

/* Plus button: visual 42px, hit 44px */
.plusBtn{
  width:44px;height:44px;border-radius:14px;border:none;background:transparent;
  color:#fff;font-weight: var(--wTitle);font-size:22px;cursor:pointer;position:relative;
}
.plusBtn::before{
  content:"";
  position:absolute; inset:1px;
  border-radius:13px;
  background:#1e88e5;
}
.plusBtn > span{ position:relative; z-index:1; display:inline-block; transform:translateY(-1px); }
.plusBtn:active{transform:scale(.98)}
body.highContrast .plusBtn::before{
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.08), inset 0 0 0 1px rgba(15,23,42,.16);
}
body.highContrast .plusBtn:active{transform:scale(.99)}
body.highContrast .plusBtn:active::before{box-shadow:inset 0 0 0 2px var(--hcInset);}

.progress-container{
  background:var(--muted2);
  height:10px;
  border-radius:6px;
  overflow:hidden;
  margin:8px 0 6px 0;
  position:relative;
}

/* Tick markers 25/50/75 */
.progress-container::before{
  content:"";
  position:absolute; inset:0;
  background:
    linear-gradient(to right,
      transparent 24.75%, rgba(15,23,42,.14) 25%, transparent 25.25%,
      transparent 49.75%, rgba(15,23,42,.14) 50%, transparent 50.25%,
      transparent 74.75%, rgba(15,23,42,.14) 75%, transparent 75.25%
    );
  opacity:.35;
  pointer-events:none;
}
body.compact .progress-container::before{ opacity:.22; }
body.highContrast .progress-container::before{ opacity:.22; }

.progress-container.tick50::before{
  background:
    linear-gradient(to right,
      transparent 24.75%, rgba(15,23,42,.14) 25%, transparent 25.25%,
      transparent 49.55%, rgba(15,23,42,.26) 50%, transparent 50.45%,
      transparent 74.75%, rgba(15,23,42,.14) 75%, transparent 75.25%
    );
  animation:tick50 .2s ease;
}
@keyframes tick50{0%{opacity:.22}50%{opacity:.65}100%{opacity:.22}}

.progress-container.bustRing{ box-shadow:0 0 0 3px rgba(239,68,68,.22); }
.progress-container.bustFlash::after{
  content:"";
  position:absolute; inset:-2px;
  border-radius:10px;
  background:rgba(239,68,68,.16);
  animation:bustFlash .45s ease forwards;
  pointer-events:none;
}
@keyframes bustFlash{ 0%{opacity:0} 20%{opacity:1} 100%{opacity:0} }

.progress-container.barGlow::after{
  content:"";
  position:absolute; inset:-2px;
  border-radius:10px;
  box-shadow:0 0 0 3px rgba(30,136,229,.16);
  opacity:0;
  animation:barGlow .2s ease forwards;
  pointer-events:none;
}
@keyframes barGlow{0%{opacity:0}40%{opacity:1}100%{opacity:0}}

.progress-bar{height:100%;transition:width .35s ease; transform-origin:left center;}
.progress-bar.resetBounce{ animation:resetBounce .22s ease; }
@keyframes resetBounce{ 0%{transform:scaleX(1)} 55%{transform:scaleX(.985)} 100%{transform:scaleX(1)} }

.divider{height:1px;background:rgba(15,23,42,.12);margin:8px 0}
.player-line{
  display:flex;align-items:baseline;justify-content:space-between;gap:10px;
  font-weight: var(--wBody);
}
.sub{
  font-weight: var(--wBody);
  color: var(--sub);
  font-size: var(--fsSecondary);
}
.dim{
  color: var(--sub2);
  font-weight: var(--wSecondary);
  font-size: var(--fsSecondary);
}
.totalBig{
  font-weight: var(--wTitle);
  font-size: 17px; /* score dominates */
}
body.compact .player-line{ font-size: 15px; }
body.compact .sub, body.compact .dim{ font-size: 13px; }

.deltaPill{
  display:inline-flex; align-items:center;
  margin-left:8px;
  padding:4px 8px; border-radius:999px;
  font-weight: var(--wTitle);
  font-size: var(--fsSecondary);
  background:#e9edf3; color:var(--sub);
  animation:deltaIn .2s ease;
}
.deltaPill.bust{background:#ffe3e3;color:#8a1f1f}
@keyframes deltaIn{0%{opacity:0;transform:translateY(2px)}100%{opacity:1;transform:translateY(0)}}

.player-box.bustAnim{ animation:bustShake .28s ease; }
@keyframes bustShake{ 0%{transform:translateX(0)} 25%{transform:translateX(-2px)} 50%{transform:translateX(2px)} 75%{transform:translateX(-1px)} 100%{transform:translateX(0)} }

.bustToast{
  position:absolute; top:10px; right:12px;
  background:rgba(239,68,68,.12);
  color:#8a1f1f;
  border:1px solid rgba(239,68,68,.25);
  padding:6px 10px;
  border-radius:999px;
  font-weight: var(--wTitle);
  font-size: var(--fsSecondary);
  animation:toastInOut .5s ease forwards;
  pointer-events:none;
}
@keyframes toastInOut{
  0%{opacity:0; transform:translateY(-4px)}
  20%{opacity:1; transform:translateY(0)}
  80%{opacity:1}
  100%{opacity:0; transform:translateY(-4px)}
}

/* Chips scroller + fades */
.cardFade{ position:relative; margin-top:8px; }
.card-container{
  display:flex; gap:6px;
  overflow-x:auto; -webkit-overflow-scrolling:touch;
  padding:0 2px 2px 2px;
  scroll-behavior:smooth;
  touch-action: pan-x; /* reduce vertical scroll hang */
}
.card-container::-webkit-scrollbar{display:none}
.cardFade::before,.cardFade::after{
  content:"";
  position:absolute; top:0; bottom:0;
  width:22px;
  pointer-events:none;
  opacity:0;
  transition:opacity .12s ease;
}
.cardFade::before{
  left:0;
  background:linear-gradient(to right, rgba(246,247,249,1), rgba(246,247,249,0));
}
.cardFade::after{
  right:0;
  background:linear-gradient(to left, rgba(246,247,249,1), rgba(246,247,249,0));
}
.cardFade.showLeft::before{opacity:1}
.cardFade.showRight::after{opacity:1}

.cardchip{
  background:var(--muted);
  padding:7px 10px;
  border-radius:999px;
  font-weight: var(--wBody);
  font-size: 14px;
  cursor:pointer;
  user-select:none;
  flex:0 0 auto;
}
.cardchip:active{transform:scale(.98)}
@keyframes chipOut{to{opacity:0;transform:scale(.96)}}

#endRoundBtn{
  width:100%;
  border:none;
  border-radius: var(--rCard);
  padding:16px 12px;
  font-weight: var(--wTitle);
  cursor:pointer;
  min-height:54px;
  background:#22c55e;
  color:#fff;
  box-shadow:0 12px 28px rgba(34,197,94,.18);
  position:relative;
}
#endRoundBtn:disabled{background:#cbd5e1;color:#475569;box-shadow:none;cursor:not-allowed}
#endRoundBtn.press{transform:scale(.99)}
#endRoundBtn.saved::after{
  content:"âœ“";
  position:absolute; right:16px; top:50%;
  transform:translateY(-50%);
  font-weight:1100;
  opacity:0;
  animation:savedTick .4s ease forwards;
}
@keyframes savedTick{ 0%{opacity:0;transform:translateY(-50%) scale(.9)} 35%{opacity:1;transform:translateY(-50%) scale(1)} 100%{opacity:0;transform:translateY(-50%) scale(1)} }
body.highContrast #endRoundBtn{ box-shadow: inset 0 0 0 1px rgba(255,255,255,.10); }
body.highContrast #endRoundBtn:active{ box-shadow: inset 0 0 0 2px rgba(0,0,0,.12); }

#statsWrap{
  margin:12px 0 14px 0;
  background:var(--card);
  border-radius: var(--rCard);
  box-shadow: var(--sh1),0 10px 25px rgba(0,0,0,.06);
  padding:12px
}
body.highContrast #statsWrap{ box-shadow:none; border:1px solid var(--hcBorder); }
#statsHead{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
#statsHead strong{font-weight: var(--wBody)}
#stats{display:none;margin-top:10px;font-weight: var(--wBody);line-height:1.55}

.overlay{
  display:none; position:fixed; inset:0; background:rgba(0,0,0,.35);
  z-index:500; opacity:0; transition:opacity .18s ease;
}
.overlay.open{opacity:1}

/* Popup */
.popup{
  display:none;
  position:fixed; top:6%; left:50%;
  transform:translateX(-50%) translateY(12px);
  width:92%; max-width:560px;
  background:var(--card);
  padding:16px;
  border-radius: 18px;
  max-height:88%;
  overflow:auto;
  z-index:1000;
  opacity:0;
  transition:opacity .18s ease,transform .18s ease;
  will-change: transform;
  border:1px solid rgba(15,23,42,.10);
}
body.highContrast .popup{ box-shadow:none; border:1px solid var(--hcBorder); }
.popup.open{opacity:1;transform:translateX(-50%) translateY(0)}
@media (orientation:landscape){
  .popup{ top:3%; max-height:94%; }
  #rankingPanel.open{max-height:360px}
}
.grabBarWrap{display:flex; justify-content:center; padding:4px 0 8px 0;}
.grabBar{width:54px; height:5px; border-radius:999px; background:rgba(15,23,42,.18);}

.popupHeader{
  position:sticky; top:0; background:var(--card); padding:0 0 10px 0; z-index:6;
  border-bottom:1px solid rgba(15,23,42,.10);
}
.headerRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
.tabs{display:flex;gap:8px;margin:10px 0 0 0}
.tab{
  flex:1;background:var(--muted);border:none;border-radius:12px;padding:10px 12px;
  font-weight: var(--wBody);cursor:pointer;min-height:48px
}
.tab.active{background:#1e88e5;color:#fff}
body.highContrast .tab{ box-shadow:inset 0 0 0 1px rgba(15,23,42,.12); }
body.highContrast .tab:active{ box-shadow:inset 0 0 0 2px var(--hcInset); }

.selectedWrap{background:var(--bg);border-radius: var(--rBtn);padding:10px;margin:10px 0}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{
  background:#fff;border:1px solid #e2e6ee;border-radius:999px;
  padding:8px 10px;font-weight: var(--wBody);cursor:pointer;user-select:none;
}
.chip:active{transform:scale(.98)}
@keyframes chipIn{0%{opacity:0;transform:translateX(-4px)}100%{opacity:1;transform:translateX(0)}}
.chip.addAnim{ animation:chipIn .12s ease; }
.chip.removing{ animation:chipOut .12s ease forwards; }

.hint{
  font-size: var(--fsSecondary);
  font-weight: var(--wBody);
  color: var(--sub);
  margin-top:8px;padding:8px 10px;border-radius:12px;background:#fff;border:1px solid var(--muted)
}
.hint.bust{background:#ffe3e3;border-color:#ffc3c3;color:#8a1f1f}
.hint.bonus{background:#e9ffe9;border-color:#c5f3c5;color:#145214}

.gridNumbers{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.gridMods{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}

.cardBtn{
  border:none;border-radius: var(--rBtn);padding:16px 0;font-weight: var(--wTitle);font-size:1.05rem;
  cursor:pointer;min-height:48px;
  box-shadow:inset 0 0 0 1px rgba(15,23,42,.10);
}
.cardBtn:active{transform:scale(.98)}
body.highContrast .cardBtn:active{ box-shadow:inset 0 0 0 2px var(--hcInset); transform:scale(.99); }
.cardBtn.modBtn{background:var(--mod)!important;color:#1a1a1a!important;box-shadow:inset 0 0 0 1px rgba(15,23,42,.12)}
.cardBtn.x2{grid-column:auto}

.directRow{display:flex;gap:8px;align-items:center}
.directRow input{
  flex:1;padding:12px 12px;border-radius: var(--rBtn);border:1px solid #d7dbe4;font-weight: var(--wTitle);outline:none;font-size:1.05rem
}
.directRow button{
  border:none;border-radius: var(--rBtn);padding:12px 14px;font-weight: var(--wTitle);
  background:#22c55e;color:#fff;cursor:pointer;white-space:nowrap;min-height:48px
}
.lastDirectRow{margin-top:10px}
.lastDirectChip{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px; border-radius:999px; background:var(--muted);
  font-weight: var(--wTitle); cursor:pointer;
}
.lastDirectChip:active{transform:scale(.98)}

.popupFooter{
  position:sticky;
  bottom:-16px;
  background:var(--card);
  padding:10px 0 0 0;
  margin-top:12px;
  border-top:1px solid rgba(15,23,42,.10);
}
.popupFooterRow{display:flex;gap:8px;flex-wrap:wrap}
.popupFooterRow button{
  border:none;border-radius: var(--rBtn);padding:14px 12px;font-weight: var(--wTitle);
  cursor:pointer;min-height:52px;
  box-shadow:inset 0 0 0 1px rgba(15,23,42,.10);
}
.popupFooterRow button:active{transform:scale(.99)}
body.highContrast .popupFooterRow button:active{ box-shadow:inset 0 0 0 2px var(--hcInset); }
.footerIcon{min-width:56px;background:var(--muted);color:#111}
.footerGhost{flex:1;background:var(--muted);color:#111}
.footerRed{flex:1;background:#ef4444;color:#fff}
.footerBlue{flex:1;background:#1e88e5;color:#fff}

/* Winner */
#winnerScreen{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:2000}
#winnerCard{
  background:var(--card);
  padding:34px 26px;
  border-radius: var(--rSheet);
  text-align:center;
  box-shadow:var(--sh2);
  position:relative; overflow:hidden;
  animation:winnerLift .35s ease;
  border:1px solid rgba(15,23,42,.10);
}
body.highContrast #winnerCard{ box-shadow:none; border:1px solid var(--hcBorder); }
@keyframes winnerLift{0%{transform:translateY(8px);opacity:.8}100%{transform:translateY(0);opacity:1}}
.confetti{
  position:absolute; width:6px; height:10px; border-radius:2px;
  top:40%; left:50%;
  opacity:0;
  animation:confetti .7s ease forwards;
}
@keyframes confetti{
  0%{opacity:0; transform:translate(0,0) rotate(0deg)}
  20%{opacity:1}
  100%{opacity:0; transform:translate(var(--dx), var(--dy)) rotate(var(--rot))}
}

/* Round toast */
#roundToast{
  position:fixed; left:14px; right:14px;
  bottom: calc(16px + env(safe-area-inset-bottom));
  z-index:2500;
  background:rgba(15,23,42,.92);
  color:#fff;
  border-radius: var(--rCard);
  padding:12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.18);
  opacity:0; transform:translateY(10px);
  pointer-events:none;
  transition:opacity .16s ease, transform .16s ease;
}
#roundToast.show{
  opacity:1; transform:translateY(0);
  pointer-events:auto;
}
#roundToast .tText{font-weight: var(--wTitle); color:#fff; font-size: 14px}
#roundToast .tBtn{
  border:none; border-radius:12px; padding:10px 12px; font-weight: var(--wTitle);
  background:rgba(255,255,255,.14); color:#fff; cursor:pointer; min-width:84px; min-height:44px;
}
#roundToast .tBtn:active{transform:scale(.98)}

/* Bottom sheet */
#sheetOverlay{
  display:none;
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter: blur(8px);
  z-index:3000;
  opacity:0;
  transition:opacity .18s ease;
}
#sheetOverlay.open{opacity:1}

#sheet{
  position:fixed; left:0; right:0; bottom:0;
  z-index:3100;
  background:rgba(255,255,255,.98);
  border-top-left-radius:var(--rSheet);
  border-top-right-radius:var(--rSheet);
  transform:translateY(110%);
  transition:transform .22s cubic-bezier(.2,.8,.2,1);
  max-height: calc(var(--vh) * 100);
  height: calc(var(--vh) * 100);
  overflow:hidden;
  border:1px solid rgba(15,23,42,.12);
  border-bottom:none;
}
body.highContrast #sheet{ border-color: var(--hcBorder); }
#sheet.open{transform:translateY(var(--sheetTranslate, 0px));}

.sheetHeader{
  position:sticky; top:0;
  background:rgba(255,255,255,.98);
  z-index:5;
  padding:10px 14px 8px 14px;
}
.sheetGrabWrap{display:flex;justify-content:center;padding:2px 0 8px 0}
.sheetGrab{width:54px;height:5px;border-radius:999px;background:rgba(15,23,42,.18)}
.sheetHeadRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
.sheetTitle{
  font-weight: var(--wTitle);
  font-size: 16px;
  display:flex;
  align-items:center;
  gap:8px;
}
.sheetClose{
  border:none;background:var(--muted);
  border-radius:12px;min-height:44px;min-width:44px;
  font-weight: var(--wTitle);cursor:pointer;
  box-shadow:inset 0 0 0 1px rgba(15,23,42,.10);
}
.sheetClose:active{transform:scale(.99)}
body.highContrast .sheetClose:active{ box-shadow:inset 0 0 0 2px var(--hcInset); }
.sheetDivider{height:1px;background:rgba(15,23,42,.10);margin-top:10px}

.sheetBody{
  height: calc((var(--vh) * 100) - 120px);
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:0 14px calc(14px + env(safe-area-inset-bottom)) 14px;
}

/* Sticky add row at bottom of sheet body (keyboard-friendly) */
#sheetAddSticky{
  position: sticky;
  bottom: 0;
  background: rgba(255,255,255,.98);
  padding: 10px 0 calc(10px + env(safe-area-inset-bottom)) 0;
  border-top: 1px solid rgba(15,23,42,.10);
  z-index: 2;
}

.sheetSection{margin-top:14px}
.sheetSection h4{
  margin:0 0 8px 0;
  font-size: var(--fsSecondary);
  color: var(--sub2);
  font-weight: var(--wSecondary);
}
body.highContrast .sheetSection h4{ color: var(--sub2); }

.row{ display:flex; gap:8px; align-items:center; margin:8px 0; }
.row input{
  flex:1; padding:12px 12px;
  border-radius: var(--rBtn); border:1px solid #d7dbe4;
  font-weight: var(--wBody); outline:none;
}
body.highContrast .row input{ border-color: rgba(15,23,42,.18); }
.row button{
  border:none; border-radius: var(--rBtn);
  padding:12px 14px; font-weight: var(--wTitle);
  cursor:pointer; min-height:48px;
  background:#22c55e; color:#fff;
  white-space:nowrap;
  box-shadow:inset 0 0 0 1px rgba(15,23,42,.10);
}
.row button:disabled{opacity:.5;cursor:not-allowed}
.row button:active{transform:scale(.99)}
body.highContrast .row button:active{ box-shadow:inset 0 0 0 2px rgba(0,0,0,.12); }

/* List look (less "card") in compact/sheet */
.listItem{
  display:flex; align-items:center; gap:10px;
  padding:12px 6px;
  margin:0;
  background:#fff;
  border-bottom:1px solid rgba(15,23,42,.10);
}
#sheetPlayersList{
  border:1px solid rgba(15,23,42,.10);
  border-radius: var(--rBtn);
  overflow:hidden;
  background:#fff;
}
body.highContrast #sheetPlayersList{ border-color: var(--hcBorder); }
body.compact .listItem{ padding:10px 6px; }

.liDot{width:10px;height:10px;border-radius:50%}
.liName{font-weight: var(--wBody);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.liBtns{display:flex;gap:8px}
.liBtns button{
  border:none; border-radius:12px; min-height:44px; min-width:44px;
  background:var(--muted); font-weight: var(--wTitle); cursor:pointer;
  box-shadow:inset 0 0 0 1px rgba(15,23,42,.10);
}
.liBtns button:active{transform:scale(.99)}
body.highContrast .liBtns button:active{ box-shadow:inset 0 0 0 2px var(--hcInset); }

/* Delete: red trash icon (no red fill) */
.liBtns .del{
  background:transparent;
  box-shadow:none;
  color:#b91c1c;
}
.liBtns .del:active{background:rgba(239,68,68,.08); border-radius:12px}

.renameRow{ display:flex; gap:8px; align-items:center; flex:1; min-width:0; }
.renameRow input{
  flex:1;
  padding:10px 10px;
  border-radius:12px;
  border:1px solid rgba(15,23,42,.18);
  font-weight: var(--wBody);
  outline:none;
  min-width:0;
}
.renameRow button{
  border:none;
  border-radius:12px;
  min-height:44px;
  padding:0 12px;
  font-weight: var(--wTitle);
  background:var(--muted);
  cursor:pointer;
  box-shadow:inset 0 0 0 1px rgba(15,23,42,.10);
}
.renameRow button:active{transform:scale(.99)}
body.highContrast .renameRow button:active{ box-shadow:inset 0 0 0 2px var(--hcInset); }

.toggleRow{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:12px 10px;
  border-radius: var(--rBtn);
  border:1px solid rgba(15,23,42,.10);
  margin:8px 0;
  background:#fff;
}
.toggleRow .tLabel{font-weight: var(--wBody); color: var(--text); opacity:.85}
.switch{
  width:52px;height:30px;border-radius:999px;
  background:#cbd5e1; position:relative; cursor:pointer; flex:0 0 auto;
  box-shadow:inset 0 0 0 1px rgba(15,23,42,.10);
}
.switch::after{
  content:"";
  position:absolute; top:3px; left:3px;
  width:24px;height:24px;border-radius:50%;
  background:#fff;
  box-shadow:0 1px 3px rgba(0,0,0,.14);
  transition:left .18s ease;
}
.switch.on{background:#22c55e}
.switch.on::after{left:25px}
.switch:active{ box-shadow:inset 0 0 0 2px rgba(15,23,42,.14); }
body.highContrast .switch:active{ box-shadow:inset 0 0 0 2px var(--hcInset); }

.sheetDestructive{
  width:100%;
  text-align:left;
  padding:14px 12px;
  border-radius: var(--rBtn);
  border:1px solid rgba(15,23,42,.10);
  background:#fff;
  font-weight: var(--wTitle);
  color:#b91c1c;
  cursor:pointer;
}
.sheetDestructive:active{ background:rgba(239,68,68,.06); }
body.highContrast .sheetDestructive:active{ box-shadow:inset 0 0 0 2px var(--hcInset); }
</style>
</head>

<body>

<div id="topbar">
  <h1>Flip 7 â€“ Score Tracker</h1>

  <div id="leaderStrip">
    <div id="leaderLeft">
      <div id="leaderLine">
        <div id="leaderDot"></div>
        <div id="leaderTextWrap">
          <span id="leaderCrown">ðŸ‘‘</span>
          <span id="leaderName">Noch keine Spieler</span>
          <span id="leaderScore"></span>
        </div>
      </div>
      <div id="leaderHint">Ã–ffne â‹¯ um Spieler zu verwalten.</div>
      <div id="subLine">
        <span id="roundBadge" class="badge">Runde: 0</span>
        <span id="goalBadge" class="badge">Ziel: 200</span>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <button id="rankBtn" class="iconBtn" type="button" aria-label="Ranking" aria-expanded="false">â‰¡</button>
      <button id="toolsBtn" class="iconBtn" type="button" aria-label="Tools" aria-expanded="false">â‹¯</button>
    </div>
  </div>

  <div id="rankingPanel"></div>
</div>

<div id="targetRow">
  <strong>Ziel</strong>
  <input type="number" id="targetPoints" value="200" inputmode="numeric" pattern="[0-9]*" />
</div>

<div id="emptyState">Keine Spieler. Ã–ffne â‹¯ â†’ <b>Spieler verwalten</b>.</div>

<div id="playersContainer"></div>

<div id="statsWrap">
  <div id="statsHead">
    <strong>Statistik</strong>
    <span id="statsChevron">â–¼</span>
  </div>
  <div id="stats"></div>
</div>

<div id="bottomBar">
  <button id="endRoundBtn" type="button">Zwischenrunde beenden</button>
</div>

<div id="roundToast">
  <div class="tText">Runde gespeichert</div>
  <button class="tBtn" id="toastUndoBtn" type="button">Undo</button>
</div>

<!-- Tools menu -->
<div id="toolsMenu" role="menu" aria-label="Tools-MenÃ¼">
  <button class="menuItem" id="manageBtn" type="button" role="menuitem">Spieler verwalten</button>
  <div class="menuSep"></div>
  <button class="menuItem" id="colorsBtn" type="button" role="menuitem">Farben neu verteilen</button>
  <div class="menuSep"></div>
  <button class="menuItem" id="undoBtn" type="button" role="menuitem">Undo</button>
  <button class="menuItem" id="undoRoundBtn" type="button" role="menuitem">Undo Runde</button>
  <div class="menuSep"></div>
  <button class="menuItem danger" id="newGameBtn" type="button" role="menuitem">New Game</button>
</div>

<!-- Bottom sheet -->
<div id="sheetOverlay"></div>
<div id="sheet" aria-hidden="true">
  <div class="sheetHeader" id="sheetHeader">
    <div class="sheetGrabWrap" id="sheetGrabArea"><div class="sheetGrab"></div></div>
    <div class="sheetHeadRow">
      <div class="sheetTitle" id="sheetTitle">Spieler</div>
      <button class="sheetClose" id="sheetCloseBtn" type="button" aria-label="SchlieÃŸen">âœ•</button>
    </div>
    <div class="sheetDivider"></div>
  </div>

  <div class="sheetBody" id="sheetBody">
    <div class="sheetSection">
      <h4>Spieler (nur vor Spielstart)</h4>

      <div id="sheetPlayersList"></div>

      <div style="font-weight:var(--wSecondary);color:var(--sub2);font-size:var(--fsSecondary); margin-top:10px;">
        WÃ¤hrend des Spiels ist Spielerverwaltung gesperrt.
      </div>

      <!-- Sticky add row -->
      <div id="sheetAddSticky">
        <div class="row" id="sheetAddRow" style="margin:0;">
          <input id="sheetAddName" type="text" placeholder="Spielername" autocomplete="off" />
          <button id="sheetAddBtn" type="button">HinzufÃ¼gen</button>
        </div>
      </div>
    </div>

    <div class="sheetSection">
      <h4>Design</h4>
      <div class="toggleRow">
        <div class="tLabel">Compact Mode</div>
        <div id="toggleCompact" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
      </div>
      <div class="toggleRow">
        <div class="tLabel">High Contrast</div>
        <div id="toggleContrast" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
      </div>
    </div>

    <div class="sheetSection">
      <h4>Spiel</h4>
      <button id="sheetNewGameBtn" class="sheetDestructive" type="button">New Game</button>
    </div>

    <div style="height:10px"></div>
  </div>
</div>

<!-- Popup -->
<div class="overlay" id="overlay"></div>
<div class="popup" id="popup">
  <div class="popupHeader" id="popupHeader">
    <div class="grabBarWrap" id="grabArea">
      <div class="grabBar"></div>
    </div>

    <div class="headerRow">
      <h3 id="popupTitle" style="margin:0;font-size:17px;font-weight:var(--wTitle);">Karten</h3>
      <div class="headerRight">
        <span id="popupPlayerBadge" class="badge"></span>
      </div>
    </div>

    <div class="tabs">
      <button id="tabCards" class="tab active" type="button">Karten</button>
      <button id="tabDirect" class="tab" type="button">Direktpunkte</button>
    </div>
  </div>

  <div id="popupCardsView">
    <div class="selectedWrap">
      <div id="selectedChips" class="chips"></div>
      <div id="popupLiveInfo" class="hint">Vorschau: â€“</div>
    </div>

    <div style="font-weight:var(--wTitle);margin:12px 0 8px 0;">Zahlen</div>
    <div id="numberGrid" class="gridNumbers"></div>

    <div style="font-weight:var(--wTitle);margin:12px 0 8px 0;">Modifier</div>
    <div id="modGrid" class="gridMods"></div>
  </div>

  <div id="popupDirectView" style="display:none;">
    <div class="selectedWrap">
      <div class="hint">Direktpunkte Ã¼berschreiben die Karten dieser Runde (kein Bust/Bonus).</div>
    </div>
    <div class="directRow">
      <input id="freeScoreInput" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Punkte eingeben (z.B. 37)" />
      <button id="applyFreeBtn" type="button">Ãœbernehmen</button>
    </div>
    <div class="lastDirectRow">
      <div id="lastDirectChip" class="lastDirectChip" style="display:none;">Letztes: <span id="lastDirectVal"></span></div>
    </div>
  </div>

  <div class="popupFooter">
    <div class="popupFooterRow">
      <button class="footerIcon" id="popupUndoBtn" type="button" aria-label="Undo letzte Auswahl">â†©ï¸Ž</button>
      <button class="footerGhost" id="clearBtn" type="button">Leeren</button>
      <button class="footerRed" id="cancelBtn" type="button">Abbrechen</button>
      <button class="footerBlue" id="finishBtn" type="button">Fertig</button>
    </div>
  </div>
</div>

<!-- Winner -->
<div id="winnerScreen">
  <div id="winnerCard">
    <h2 id="winnerText" style="margin:0 0 16px 0;font-weight:var(--wTitle);"></h2>
    <button class="iconBtn" id="winnerNewGame" type="button" style="background:#22c55e;color:#fff;width:100%;">Neues Spiel</button>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
const $ = (id)=>document.getElementById(id);
function vib(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){} }
function lockScroll(lock){ document.body.style.overflow = lock ? "hidden" : ""; }
const reduceMotion = () => window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

/* iOS keyboard vh fix */
function setVh(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty("--vh", vh + "px");
}
setVh();
window.addEventListener("resize", setVh, {passive:true});
window.addEventListener("orientationchange", setVh, {passive:true});

/* Top/bottom bar alpha changes with scroll */
function updateBarAlpha(){
  const y = window.scrollY || 0;
  // 0..120px => .94.. .86
  const a = Math.max(0.86, 0.94 - (y/120)*0.08);
  document.documentElement.style.setProperty("--barAlpha", a.toFixed(3));
}
updateBarAlpha();
window.addEventListener("scroll", updateBarAlpha, {passive:true});

/* Haptik: nur "open sheet", "snap reached", "commit", "delete confirmed", "bust", "win" */
const HAPT = {
  finish:18,
  bust:28,
  win:40,
  sheetOpen:12,
  sheetSnap:10,
  delete:18
};

/* Number colors */
const numStyle = {
  0: { bg:"linear-gradient(135deg,#0cb5be 0%,#0cb5be 20%,#e70200 20%,#e70200 40%,#c2549b 40%,#c2549b 60%,#fd8803 60%,#fd8803 80%,#ffffff 80%,#ffffff 100%)", fg:"#0b1220" },
  1: { bg:"#cbb59e" },
  2: { bg:"#dce100" },
  3: { bg:"#f14355", fg:"#fff" },
  4: { bg:"#0cb5be", fg:"#fff" },
  5: { bg:"#329a4c", fg:"#fff" },
  6: { bg:"#c2549b", fg:"#fff" },
  7: { bg:"#d87665", fg:"#fff" },
  8: { bg:"#b6e076" },
  9: { bg:"#fd8803", fg:"#fff" },
  10:{ bg:"#e70200", fg:"#fff" },
  11:{ bg:"#8eabda" },
  12:{ bg:"#937972", fg:"#fff" }
};

let players=[];
let roundNumber=0;
let gameLocked=false;

let selectedPlayer=null;
let popupCards=[];
let popupOverride=null;
let popupActionStack=[];
let lastDirectScore=null;

let undoStack=[];
let undoRoundStack=[];

let statsOpen=false;
let lastLeaderName=null;
let lastLeaderScore=0;

let popupStatePushed=false;
let sheetStatePushed=false;

const palette=[
  "#2563eb","#16a34a","#ea580c","#9333ea",
  "#0ea5e9","#dc2626","#14b8a6","#eab308",
  "#111827","#f97316","#22c55e","#3b82f6"
];
const numbers=[...Array(13).keys()];

/* ---------- Persistenz ---------- */
function snapshot(){
  return JSON.parse(JSON.stringify({
    players, roundNumber, gameLocked,
    target:Number($("targetPoints").value)||200,
    statsOpen, lastLeaderName, lastLeaderScore, lastDirectScore,
    compact:document.body.classList.contains("compact"),
    contrast:document.body.classList.contains("highContrast"),
  }));
}
function restore(s){
  players=s.players||[];
  roundNumber=typeof s.roundNumber==="number"?s.roundNumber:0;
  gameLocked=!!s.gameLocked;
  if(typeof s.target==="number") $("targetPoints").value=s.target;
  statsOpen=!!s.statsOpen;
  lastLeaderName = s.lastLeaderName ?? null;
  lastLeaderScore = typeof s.lastLeaderScore==="number" ? s.lastLeaderScore : 0;
  lastDirectScore = (typeof s.lastDirectScore==="number") ? s.lastDirectScore : null;

  document.body.classList.toggle("compact", !!s.compact);
  document.body.classList.toggle("highContrast", !!s.contrast);

  syncTogglesUI();
  renderAll();
  save();
}
function pushUndo(){
  undoStack.push(snapshot());
  if(undoStack.length>60) undoStack.shift();
}
function pushUndoRound(){
  undoRoundStack.push(snapshot());
  if(undoRoundStack.length>30) undoRoundStack.shift();
}
function save(){ localStorage.setItem("flip7_state_v8", JSON.stringify(snapshot())); }
function load(){
  const raw=localStorage.getItem("flip7_state_v8");
  if(!raw) return;
  try{ restore(JSON.parse(raw)); }catch(e){}
}

/* ---------- Regeln ---------- */
function scoreFromCards(cards){
  const nums=cards.filter(c=>typeof c==="number");
  const mods=cards.filter(c=>typeof c==="string");

  const isBust = (nums.length===0) || (new Set(nums).size !== nums.length);
  if(isBust) return {score:0,isBust:true,numbersCount:nums.length, reason:(nums.length===0?"Keine Zahl gewÃ¤hlt":"Doppelte Zahl")};

  const sumNums = nums.reduce((a,b)=>a+b,0);

  let multi=1;
  for(const m of mods){ if(m==="x2") multi*=2; }

  let modSum=0;
  for(const m of mods){ if(m.startsWith("+")) modSum += Number(m.slice(1)); }

  const bonus = (nums.length===7) ? 15 : 0;

  return { score:(sumNums*multi)+modSum+bonus, isBust:false, numbersCount:nums.length, reason:"" };
}

function getRanking(){
  return [...players].map(p=>{
    const live = (p.override!==null) ? p.override : scoreFromCards(p.cards).score;
    return {name:p.name,color:p.color,score:p.total+live};
  }).sort((a,b)=>b.score-a.score);
}

/* ---------- Count up ---------- */
function animateCountUpText(el, from, to, ms){
  if(reduceMotion() || from===to){
    el.textContent = to;
    return;
  }
  const start=performance.now();
  function step(now){
    const t=Math.min((now-start)/ms,1);
    const eased=1-Math.pow(1-t,2);
    el.textContent = Math.round(from+(to-from)*eased);
    if(t<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ---------- Top render ---------- */
function renderTop(){
  const target=Number($("targetPoints").value)||200;

  const compact = document.body.classList.contains("compact");
  $("roundBadge").textContent = compact ? String(roundNumber) : ("Runde: "+roundNumber);
  $("goalBadge").textContent  = compact ? String(target) : ("Ziel: "+target);

  if(!players.length){
    $("leaderHint").style.display="block";
    $("leaderDot").style.background="#cbd5e1";
    $("leaderName").textContent="Noch keine Spieler";
    $("leaderScore").textContent="";
    return;
  }
  $("leaderHint").style.display="none";
  const list=getRanking();
  const leader=list[0];

  $("leaderDot").style.background=leader.color;

  const changed = (lastLeaderName !== null && leader.name !== lastLeaderName);
  const scoreChanged = leader.score !== lastLeaderScore;

  if(changed){
    $("leaderStrip").classList.add("spotlight");
    setTimeout(()=>$("leaderStrip").classList.remove("spotlight"), 650);

    $("leaderCrown").classList.add("pop");
    setTimeout(()=>$("leaderCrown").classList.remove("pop"), 250);

    $("leaderName").classList.add("crossfade");
    setTimeout(()=>$("leaderName").classList.remove("crossfade"), 170);
  }

  $("leaderName").textContent = leader.name;

  const scoreEl = $("leaderScore");
  scoreEl.classList.toggle("crossfade", changed || scoreChanged);
  setTimeout(()=>scoreEl.classList.remove("crossfade"), 170);

  animateCountUpText(scoreEl, lastLeaderScore, leader.score, 160);

  lastLeaderName = leader.name;
  lastLeaderScore = leader.score;
}

/* ---------- Ranking panel ---------- */
function renderRanking(){
  const list=getRanking();
  const panel=$("rankingPanel");

  panel.innerHTML = list.length ? list.map((p,i)=>`
    <div class="rankItem" data-key="${escapeHtml(p.name)}">
      <div class="rankNo">${i+1}.</div>
      <div class="rankDot" style="background:${p.color}"></div>
      <div class="rankName">${escapeHtml(p.name)}</div>
      <div class="rankScore">${p.score}</div>
    </div>
  `).join("") : `<div style="font-weight:700;color:#555;">Noch keine Spieler</div>`;
}

/* Track bar % to add snap+glow when changed */
const prevBarPct = new Map();

/* ---------- Chips fade helpers ---------- */
function updateFadeFor(wrapper){
  const sc = wrapper.querySelector(".card-container");
  if(!sc) return;
  const max = Math.max(0, sc.scrollWidth - sc.clientWidth);
  const left = sc.scrollLeft;
  wrapper.classList.toggle("showLeft", left > 2);
  wrapper.classList.toggle("showRight", left < max - 2);
}
function wireChipFades(){
  document.querySelectorAll(".cardFade").forEach(w=>{
    const sc = w.querySelector(".card-container");
    if(!sc) return;
    const on = ()=>updateFadeFor(w);
    sc.addEventListener("scroll", on, {passive:true});
    requestAnimationFrame(on);
  });
}

/* ---------- Players render ---------- */
function renderPlayers(){
  const target=Number($("targetPoints").value)||200;
  const rank=getRanking();
  const leaderName = rank.length ? rank[0].name : null;
  const compact = document.body.classList.contains("compact");

  const wrap=$("playersContainer");
  wrap.innerHTML="";

  players.forEach((p,i)=>{
    const res = (p.override!==null)
      ? {score:p.override,isBust:(p.override===0),numbersCount:0, reason:""}
      : scoreFromCards(p.cards);

    const live=res.score;
    const total=p.total+live;

    const bonusBadge = (p.cards.length && !res.isBust && res.numbersCount===7) ? `<span class="miniBadge action">+15</span>` : "";
    const manualBadge = (p.override!==null) ? `<span class="miniBadge">manuell</span>` : "";

    const div=document.createElement("div");
    div.className="player-box"+(leaderName===p.name?" leader":"");
    div.style.borderLeftColor=p.color;

    const pct = target ? Math.min((total/target)*100,100) : 0;
    const prev = prevBarPct.get(p.name);
    const barGlow = (prev!=null && Math.abs(prev-pct) > 0.01);
    prevBarPct.set(p.name, pct);

    const left = Math.max(target-total,0);

    const leftLabel = compact
      ? `<button class="sub" data-direct="1" data-i="${i}" style="border:none;background:transparent;padding:0;text-decoration:underline;cursor:pointer">${live}</button>
         <span id="delta_${i}"></span>`
      : `<button class="sub" data-direct="1" data-i="${i}" style="border:none;background:transparent;padding:0;text-decoration:underline;cursor:pointer">Runde: ${live}</button>
         <span id="delta_${i}"></span>`;

    const rightLabel = compact
      ? `<span><span class="totalBig" id="total_${i}">${total}</span>/<span>${target}</span> <span class="dim">(âˆ’<span id="left_${i}">${left}</span>)</span></span>`
      : `<span><span class="totalBig" id="total_${i}">${total}</span>/<span>${target}</span> <span class="dim">(noch <span id="left_${i}">${left}</span>)</span></span>`;

    div.innerHTML=`
      <div class="player-top">
        <div class="player-name">
          <span class="player-dot" style="background:${p.color}"></span>
          <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(p.name)}</span>
          ${bonusBadge} ${manualBadge}
        </div>
        <button class="plusBtn" type="button" data-i="${i}" aria-label="Punkte/Karten"><span>+</span></button>
      </div>

      <div class="progress-container ${barGlow ? "barGlow":""}" id="pc_${i}">
        <div class="progress-bar" id="pb_${i}" style="width:${pct}%; background:${p.color}"></div>
      </div>

      <div class="divider"></div>

      <div class="player-line">
        <span class="sub">${leftLabel}</span>
        ${rightLabel}
      </div>

      ${p.cards.length?`
        <div class="cardFade" id="fade_${i}">
          <div class="card-container" id="chips_${i}">
            ${p.cards.map((c,ci)=>`<span class="cardchip" data-rem="${ci}" data-i="${i}">${escapeHtml(String(c))}</span>`).join("")}
          </div>
        </div>
      `:""}
    `;
    wrap.appendChild(div);
  });

  wireChipFades();
}

/* ---------- Stats ---------- */
function renderStats(){
  const box=$("stats");
  if(!players.length){ box.innerHTML=`<div style="font-weight:700;color:#555;">Noch keine Daten</div>`; return; }
  box.innerHTML = players.map(p=>{
    const avg=(p.rounds.reduce((a,b)=>a+b,0)/(p.rounds.length||1)).toFixed(1);
    const bustQ=p.rounds.length?Math.round((p.busts/p.rounds.length)*100):0;
    return `<div style="margin:6px 0;"><b>${escapeHtml(p.name)}</b>: Ã˜ ${avg} â€¢ Bust ${bustQ}% (${p.busts}/${p.rounds.length})</div>`;
  }).join("");
}

/* ---------- Locks ---------- */
function updateLocks(){
  $("targetRow").style.display = gameLocked ? "none" : "flex";
  $("emptyState").style.display = players.length? "none" : "block";
  $("endRoundBtn").disabled = players.length===0;

  const canManage = (!gameLocked && roundNumber===0);
  $("sheetAddBtn").disabled = !canManage;

  const colors = players.map(p=>p.color);
  const hasDup = new Set(colors).size !== colors.length;
  $("colorsBtn").disabled = !(players.length>palette.length || hasDup);

  $("undoBtn").disabled = undoStack.length===0;
  $("undoRoundBtn").disabled = undoRoundStack.length===0;
}

/* ---------- Render all ---------- */
function renderAll(){
  renderTop();
  renderRanking();
  renderPlayers();
  renderStats();
  $("stats").style.display = statsOpen ? "block" : "none";
  $("statsChevron").textContent = statsOpen ? "â–²" : "â–¼";
  updateLocks();
}

/* ---------- Tools Menu (FIXED: pointer-based, no immediate close) ---------- */
const toolsBtnEl = $("toolsBtn");
const toolsMenuEl = $("toolsMenu");
document.body.appendChild(toolsMenuEl);

let toolsMenuOpen=false;

function positionToolsMenu(){
  const r = toolsBtnEl.getBoundingClientRect();
  const w = toolsMenuEl.offsetWidth || 240;
  const margin = 8;
  let left = r.right - w;
  let top  = r.bottom + margin;
  left = Math.max(margin, Math.min(left, window.innerWidth - w - margin));
  top  = Math.max(margin, Math.min(top, window.innerHeight - toolsMenuEl.offsetHeight - margin));
  toolsMenuEl.style.left = left + "px";
  toolsMenuEl.style.top  = top + "px";
}
function closeToolsMenu(){
  toolsMenuOpen=false;
  toolsMenuEl.classList.remove("open");
  toolsBtnEl.setAttribute("aria-expanded","false");
}
function openToolsMenu(){
  toolsMenuOpen=true;
  toolsMenuEl.classList.add("open");
  toolsBtnEl.setAttribute("aria-expanded","true");
  positionToolsMenu();
}
function toggleToolsMenu(){ toolsMenuOpen ? closeToolsMenu() : openToolsMenu(); }

toolsBtnEl.addEventListener("pointerdown",(e)=>{
  e.preventDefault();
  e.stopPropagation();
}, {passive:false});

toolsBtnEl.addEventListener("pointerup",(e)=>{
  e.preventDefault();
  e.stopPropagation();
  toggleToolsMenu();
}, {passive:false});

toolsMenuEl.addEventListener("pointerdown",(e)=>{ e.stopPropagation(); }, {passive:true});
toolsMenuEl.addEventListener("pointerup",(e)=>{ e.stopPropagation(); }, {passive:true});

document.addEventListener("pointerdown",(e)=>{
  if(!toolsMenuOpen) return;
  if(e.target === toolsBtnEl) return;
  if(toolsMenuEl.contains(e.target)) return;
  closeToolsMenu();
}, {passive:true, capture:true});

window.addEventListener("resize",()=>{ if(toolsMenuOpen) positionToolsMenu(); }, {passive:true});
window.addEventListener("scroll",()=>{ if(toolsMenuOpen) positionToolsMenu(); }, {passive:true});

/* ---------- Ranking toggle ---------- */
$("rankBtn").addEventListener("pointerup",(e)=>{
  e.preventDefault(); e.stopPropagation();
  const open = $("rankingPanel").classList.toggle("open");
  $("rankBtn").setAttribute("aria-expanded", open ? "true" : "false");
  closeToolsMenu();
}, {passive:false});

/* ---------- Bottom sheet (snap points + interactive drag + history) ---------- */
const sheetOverlay=$("sheetOverlay");
const sheet=$("sheet");
const sheetBody=$("sheetBody");
const sheetTitle=$("sheetTitle");
let sheetOpen=false;
let sheetSnap="half"; // "half" | "full"
let sheetDrag=false;
let sheetStartY=0;
let sheetStartTranslate=0;
let sheetLastY=0;
let sheetStartT=0;

function computeSnapTranslate(which){
  const vh = window.innerHeight;
  const fullH = Math.round(vh * 0.90);
  const halfVisible = Math.round(vh * 0.55);
  const halfTranslate = Math.max(0, fullH - halfVisible);
  return (which==="full") ? 0 : halfTranslate;
}
function applySheetTranslate(px, withTransition){
  sheet.style.transition = withTransition ? "transform .22s cubic-bezier(.2,.8,.2,1)" : "none";
  sheet.style.setProperty("--sheetTranslate", px+"px");
}
function setSheetTitleBySnap(which){
  sheetTitle.classList.add("crossfade");
  sheetTitle.textContent = (which==="full") ? "Spieler & Einstellungen" : "Spieler";
  setTimeout(()=>sheetTitle.classList.remove("crossfade"), 160);
}
function snapSheet(which, reason){
  sheetSnap = which;
  const px = computeSnapTranslate(which);
  applySheetTranslate(px, true);
  setSheetTitleBySnap(which);
  if(reason==="user") vib(HAPT.sheetSnap);
}
function openSheet(){
  closeToolsMenu();
  sheetOverlay.style.display="block";
  requestAnimationFrame(()=>sheetOverlay.classList.add("open"));
  sheet.classList.add("open");
  sheetOverlay.classList.add("open");
  sheet.setAttribute("aria-hidden","false");
  lockScroll(true);
  sheetOpen=true;
  renderSheetPlayers();
  vib(HAPT.sheetOpen);
  snapSheet("half", "program");

  if(!sheetStatePushed){
    history.pushState({sheet:true}, "");
    sheetStatePushed=true;
  }
}
function closeSheet(){
  sheetOpen=false;
  sheet.classList.remove("open");
  sheetOverlay.classList.remove("open");
  sheet.setAttribute("aria-hidden","true");
  setTimeout(()=>{ sheetOverlay.style.display="none"; }, 180);
  lockScroll(false);
  save();

  // cleanup history state (avoid double-back)
  if(sheetStatePushed){
    sheetStatePushed=false;
    try{ history.back(); }catch(e){}
  }
}
sheetOverlay.addEventListener("pointerdown",()=>{ if(sheetOpen) closeSheet(); }, {passive:true});

window.addEventListener("popstate",()=>{
  if(sheetOpen){
    // back gesture closes sheet without commit
    sheetOpen=false;
    sheet.classList.remove("open");
    sheetOverlay.classList.remove("open");
    sheet.setAttribute("aria-hidden","true");
    setTimeout(()=>{ sheetOverlay.style.display="none"; }, 180);
    lockScroll(false);
    save();
  }
  if(popupEl && popupEl.style.display==="block"){
    popupStatePushed=false;
    internalClosePopup(true);
  }
});

function rubberBand(dy){
  const sign = dy < 0 ? -1 : 1;
  const abs = Math.abs(dy);
  const damp = abs / (abs + 260);
  return sign * abs * (1 - damp);
}
function beginSheetDrag(clientY){
  sheetDrag=true;
  sheetStartY=clientY;
  sheetLastY=clientY;
  sheetStartT=performance.now();
  sheetStartTranslate = computeSnapTranslate(sheetSnap);
  applySheetTranslate(sheetStartTranslate, false);
}
function moveSheetDrag(clientY){
  if(!sheetDrag) return;
  sheetLastY=clientY;
  const dy = sheetLastY - sheetStartY;
  let next = sheetStartTranslate + dy;

  if(next < 0) next = rubberBand(next);
  const half = computeSnapTranslate("half");
  if(next > half) next = half + rubberBand(next - half);

  applySheetTranslate(next, false);
}
function endSheetDrag(){
  if(!sheetDrag) return;
  sheetDrag=false;

  const dy = sheetLastY - sheetStartY;
  const dt = Math.max(1, performance.now() - sheetStartT);
  const v = dy / dt;

  const half = computeSnapTranslate("half");
  const current = sheetStartTranslate + dy;

  if(sheetSnap==="half"){
    const closeThresh = half + 110;
    const shouldClose = (current > closeThresh) || (v > 0.85);
    if(shouldClose){
      applySheetTranslate(half+320, true);
      setTimeout(()=>closeSheet(), 180);
      return;
    }
  }

  const toFull = (current < (half * 0.55)) || (v < -0.65);
  if(toFull) snapSheet("full", "user");
  else snapSheet("half", "user");

  sheet.style.transition = "";
}

$("sheetGrabArea").addEventListener("pointerdown",(e)=>{
  if(!sheetOpen) return;
  if(sheetBody.scrollTop > 0) return;
  beginSheetDrag(e.clientY);
  sheet.setPointerCapture?.(e.pointerId);
},{passive:true});

sheet.addEventListener("pointermove",(e)=>{
  if(!sheetDrag) return;
  moveSheetDrag(e.clientY);
},{passive:true});

sheet.addEventListener("pointerup",()=>{
  if(!sheetDrag) return;
  endSheetDrag();
},{passive:true});

window.addEventListener("resize",()=>{
  if(!sheetOpen) return;
  snapSheet(sheetSnap, "program");
}, {passive:true});

/* ---------- Sheet players (inline rename + trash icon) ---------- */
let editingIdx = null;

function renderSheetPlayers(){
  const list=$("sheetPlayersList");
  const canManage = (!gameLocked && roundNumber===0);
  $("sheetAddBtn").disabled = !canManage;

  if(!players.length){
    list.innerHTML = `<div style="padding:12px;font-weight:700;color:var(--sub2);">Noch keine Spieler.</div>`;
    return;
  }

  list.innerHTML = players.map((p,idx)=>{
    const isEdit = (editingIdx === idx);
    const nameCell = isEdit
      ? `
        <div class="renameRow">
          <input data-ren-inp="${idx}" value="${escapeHtml(p.name)}" />
          <button type="button" data-ren-done="${idx}">Done</button>
        </div>`
      : `<div class="liName">${escapeHtml(p.name)}</div>`;

    return `
      <div class="listItem">
        <div class="liDot" style="background:${p.color}"></div>
        ${nameCell}
        <div class="liBtns">
          <button type="button" data-ren="${idx}" ${canManage?"":"disabled"} aria-label="Umbenennen">âœŽ</button>
          <button type="button" class="del" data-del="${idx}" ${canManage?"":"disabled"} aria-label="LÃ¶schen">ðŸ—‘ï¸</button>
        </div>
      </div>
    `;
  }).join("");

  if(editingIdx !== null){
    const inp = list.querySelector(`[data-ren-inp="${editingIdx}"]`);
    if(inp){
      setTimeout(()=>{ inp.focus(); inp.select(); }, 60);
    }
  }
}

function addPlayerFromSheet(){
  const canManage = (!gameLocked && roundNumber===0);
  if(!canManage) return;

  const name = $("sheetAddName").value.trim();
  if(!name) return;

  pushUndo();
  const used=new Set(players.map(x=>x.color));
  const free=palette.find(c=>!used.has(c)) || palette[players.length % palette.length];

  players.push({name, color:free, cards:[], total:0, rounds:[], busts:0, override:null});
  $("sheetAddName").value="";
  editingIdx = null;
  renderAll();
  renderSheetPlayers();
  save();
}

function startRename(idx){
  const canManage = (!gameLocked && roundNumber===0);
  if(!canManage) return;
  editingIdx = idx;
  renderSheetPlayers();
}
function commitRename(idx){
  const canManage = (!gameLocked && roundNumber===0);
  if(!canManage) return;
  const inp = $("sheetPlayersList").querySelector(`[data-ren-inp="${idx}"]`);
  if(!inp) return;
  const next = inp.value.trim();
  if(!next){ editingIdx = null; renderSheetPlayers(); return; }
  pushUndo();
  players[idx].name = next;
  editingIdx = null;
  renderAll();
  renderSheetPlayers();
  save();
}

function deletePlayer(idx){
  const canManage = (!gameLocked && roundNumber===0);
  if(!canManage) return;

  const ok = confirm(`Spieler "${players[idx].name}" entfernen?`);
  if(!ok) return;

  vib(HAPT.delete);
  pushUndo();
  players.splice(idx,1);
  editingIdx = null;
  renderAll();
  renderSheetPlayers();
  save();
}

function syncTogglesUI(){
  const c = document.body.classList.contains("compact");
  const h = document.body.classList.contains("highContrast");

  const tc=$("toggleCompact");
  tc.classList.toggle("on", c);
  tc.setAttribute("aria-checked", c ? "true" : "false");

  const th=$("toggleContrast");
  th.classList.toggle("on", h);
  th.setAttribute("aria-checked", h ? "true" : "false");
}

function toggleClassSwitch(which){
  if(which==="compact"){
    document.body.classList.toggle("compact");
  }else if(which==="contrast"){
    document.body.classList.toggle("highContrast");
  }
  syncTogglesUI();
  renderAll();
  save();
}

$("manageBtn").addEventListener("pointerup",(e)=>{ e.preventDefault(); openSheet(); }, {passive:false});
$("sheetCloseBtn").addEventListener("pointerup",(e)=>{ e.preventDefault(); closeSheet(); }, {passive:false});

$("sheetAddBtn").addEventListener("pointerup",(e)=>{ e.preventDefault(); addPlayerFromSheet(); }, {passive:false});
$("sheetAddName").addEventListener("keydown",(e)=>{ if(e.key==="Enter") addPlayerFromSheet(); });

$("sheetPlayersList").addEventListener("click",(e)=>{
  const ren = e.target.closest("[data-ren]");
  const del = e.target.closest("[data-del]");
  const done = e.target.closest("[data-ren-done]");
  if(done) commitRename(Number(done.dataset.renDone));
  if(ren) startRename(Number(ren.dataset.ren));
  if(del) deletePlayer(Number(del.dataset.del));
});

$("sheetPlayersList").addEventListener("keydown",(e)=>{
  const inp = e.target.closest("[data-ren-inp]");
  if(!inp) return;
  const idx = Number(inp.dataset.renInp);
  if(e.key === "Enter") commitRename(idx);
  if(e.key === "Escape"){ editingIdx=null; renderSheetPlayers(); }
});

$("toggleCompact").addEventListener("pointerup",()=>toggleClassSwitch("compact"));
$("toggleContrast").addEventListener("pointerup",()=>toggleClassSwitch("contrast"));
$("toggleCompact").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") toggleClassSwitch("compact"); });
$("toggleContrast").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" ") toggleClassSwitch("contrast"); });

/* ---------- Popup ---------- */
const overlayEl=$("overlay"), popupEl=$("popup");
const tabCardsEl=$("tabCards"), tabDirectEl=$("tabDirect");
const cardsView=$("popupCardsView"), directView=$("popupDirectView");
let lastUndoTap=0;

function stackPopupState(){
  popupActionStack.push(JSON.parse(JSON.stringify({cards:popupCards, override:popupOverride, free:$("freeScoreInput").value})));
  if(popupActionStack.length>40) popupActionStack.shift();
}
function popupUndo(){
  if(!popupActionStack.length) return;
  const s=popupActionStack.pop();
  popupCards=s.cards;
  popupOverride=s.override;
  $("freeScoreInput").value=s.free;
  renderPopupSelection();
}
function popupUndoTap(){
  const now=Date.now();
  if(now-lastUndoTap < 260){
    clearPopup();
    lastUndoTap=0;
    return;
  }
  lastUndoTap=now;
  popupUndo();
}
function clearPopup(){
  stackPopupState();
  popupCards=[]; popupOverride=null; $("freeScoreInput").value="";
  renderPopupSelection();
}
function popupAdd(x){
  stackPopupState();
  popupCards.push(x);
  popupOverride=null;
  $("freeScoreInput").value="";
  renderPopupSelection();
}
function popupRemoveAt(idx, el){
  if(el){
    el.classList.add("removing");
    setTimeout(()=>{
      stackPopupState();
      popupCards.splice(idx,1);
      popupOverride=null;
      $("freeScoreInput").value="";
      renderPopupSelection();
    }, 120);
    return;
  }
  stackPopupState();
  popupCards.splice(idx,1);
  popupOverride=null;
  $("freeScoreInput").value="";
  renderPopupSelection();
}
function applyFree(){
  const v=Number($("freeScoreInput").value);
  if(!Number.isFinite(v) || v<0) return;
  stackPopupState();
  popupOverride=Math.floor(v);
  lastDirectScore = popupOverride;
  renderPopupSelection();
}

function renderPopupSelection(){
  const chips=$("selectedChips");
  chips.innerHTML="";
  if(!popupCards.length){
    chips.innerHTML=`<span style="font-weight:700;color:#555;">Keine Karten ausgewÃ¤hlt.</span>`;
  }else{
    popupCards.forEach((c,idx)=>{
      const d=document.createElement("div");
      d.className="chip addAnim";
      d.textContent=String(c);
      d.addEventListener("pointerdown",(e)=>{ e.preventDefault(); popupRemoveAt(idx, d); }, {passive:false});
      chips.appendChild(d);
      setTimeout(()=>d.classList.remove("addAnim"), 140);
    });
  }

  const info=$("popupLiveInfo");
  if(popupOverride!==null){
    info.className="hint";
    info.textContent=`Vorschau: ${popupOverride} Punkte (manuell)`;
    return;
  }
  if(!popupCards.length){
    info.className="hint"; info.textContent="Vorschau: â€“"; return;
  }
  const prev=scoreFromCards(popupCards);
  if(prev.isBust){
    info.className="hint bust";
    info.textContent=`Vorschau: BUST (0 Punkte) â€¢ ${prev.reason}`;
  }else{
    const isBonus=prev.numbersCount===7;
    info.className="hint"+(isBonus?" bonus":"");
    info.textContent=`Vorschau: ${prev.score} Punkte`+(isBonus?" â€¢ +15 Bonus":"");
  }
}

function setTab(t){
  tabCardsEl.classList.toggle("active", t==="cards");
  tabDirectEl.classList.toggle("active", t==="direct");
  cardsView.style.display = (t==="cards")?"block":"none";
  directView.style.display = (t==="direct")?"block":"none";
  $("popupTitle").textContent = (t==="direct") ? "Direktpunkte" : "Karten";

  if(t==="direct"){
    if(typeof lastDirectScore==="number"){
      $("lastDirectVal").textContent = lastDirectScore;
      $("lastDirectChip").style.display="inline-flex";
    }else{
      $("lastDirectChip").style.display="none";
    }
    setTimeout(()=>{
      const inp=$("freeScoreInput");
      inp.focus();
      inp.select();
    }, 60);
  }else{
    $("lastDirectChip").style.display="none";
  }
}

function openPopup(i, direct){
  selectedPlayer=i;
  popupCards=[...players[i].cards];
  popupOverride=players[i].override;
  popupActionStack=[];
  $("popupPlayerBadge").textContent=players[i].name;
  $("freeScoreInput").value = popupOverride!==null ? popupOverride : "";

  popupEl.style.display="block";
  overlayEl.style.display="block";
  requestAnimationFrame(()=>{ popupEl.classList.add("open"); overlayEl.classList.add("open"); });
  lockScroll(true);

  if(!popupStatePushed){
    history.pushState({popup:true}, "");
    popupStatePushed=true;
  }

  setTab(direct ? "direct" : "cards");
  renderPopupSelection();
}

function internalClosePopup(cancel){
  popupEl.classList.remove("open");
  overlayEl.classList.remove("open");
  setTimeout(()=>{ popupEl.style.display="none"; overlayEl.style.display="none"; }, 180);
  lockScroll(false);

  if(!cancel && selectedPlayer!==null){
    pushUndo();
    players[selectedPlayer].cards=[...popupCards];
    players[selectedPlayer].override=popupOverride;
    save();
    vib(HAPT.finish); // haptic only on successful commit
  }

  selectedPlayer=null;
  renderAll();
}

function closePopup(cancel){
  if(popupStatePushed){
    popupStatePushed=false;
    internalClosePopup(cancel);
    try{ history.back(); }catch(e){}
    return;
  }
  internalClosePopup(cancel);
}

/* swipe-to-close */
let dragActive=false, dragStartY=0, dragLastY=0, dragStartT=0;
function setPopupDragTranslate(y){ popupEl.style.transform = `translateX(-50%) translateY(${y}px)`; }
function endPopupDrag(shouldClose){
  dragActive=false;
  popupEl.style.transition = "opacity .18s ease, transform .18s cubic-bezier(.2,.8,.2,1)";
  if(shouldClose) closePopup(true);
  else setPopupDragTranslate(0);
  setTimeout(()=>{ popupEl.style.transition=""; }, 220);
}
$("grabArea").addEventListener("pointerdown",(e)=>{
  if(popupEl.scrollTop > 0) return;
  dragActive=true; dragStartY=e.clientY; dragLastY=e.clientY; dragStartT=performance.now();
  popupEl.setPointerCapture?.(e.pointerId);
  popupEl.style.transition="none";
},{passive:true});
popupEl.addEventListener("pointermove",(e)=>{
  if(!dragActive) return;
  dragLastY=e.clientY;
  const dy=Math.max(0, dragLastY - dragStartY);
  setPopupDragTranslate(Math.min(dy, 220));
},{passive:true});
popupEl.addEventListener("pointerup",()=>{
  if(!dragActive) return;
  const dy=Math.max(0, dragLastY - dragStartY);
  const dt=Math.max(1, performance.now()-dragStartT);
  const v=dy/dt;
  endPopupDrag(dy>90 || v>0.7);
},{passive:true});

/* ---------- Popup grids ---------- */
function buildPopupGrids(){
  const ng=$("numberGrid");
  ng.innerHTML="";
  numbers.forEach(n=>{
    const b=document.createElement("button");
    b.type="button"; b.className="cardBtn";
    const st=numStyle[n]||{bg:"#eef1f5",fg:"#0b1220"};
    b.style.background=st.bg; b.style.color=st.fg||"#0b1220";
    b.textContent=String(n);
    b.addEventListener("pointerdown",(e)=>{e.preventDefault(); popupAdd(n);},{passive:false});
    ng.appendChild(b);
  });

  const mg=$("modGrid");
  mg.innerHTML="";
  ["+2","+4","+6","+8","+10","x2"].forEach(m=>{
    const b=document.createElement("button");
    b.type="button"; b.className="cardBtn modBtn"+(m==="x2"?" x2":"");
    b.textContent=m;
    b.addEventListener("pointerdown",(e)=>{e.preventDefault(); popupAdd(m);},{passive:false});
    mg.appendChild(b);
  });
}

/* ---------- Round toast ---------- */
let toastTimer=null;
function showRoundToast(){
  const t=$("roundToast");
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>hideRoundToast(), 2600);
}
function hideRoundToast(){
  clearTimeout(toastTimer);
  $("roundToast").classList.remove("show");
}

/* Winner confetti */
function spawnConfetti(color){
  if(reduceMotion()) return;
  const card=$("winnerCard");
  [...card.querySelectorAll(".confetti")].forEach(x=>x.remove());
  const colors=[color, "#ffffff", "rgba(255,255,255,.65)", "rgba(15,23,42,.15)"];
  for(let i=0;i<8;i++){
    const s=document.createElement("div");
    s.className="confetti";
    s.style.background=colors[Math.floor(Math.random()*colors.length)];
    s.style.left = (40 + Math.random()*20) + "%";
    s.style.top  = (40 + Math.random()*10) + "%";
    s.style.setProperty("--dx", (Math.random()*160-80).toFixed(0)+"px");
    s.style.setProperty("--dy", (Math.random()*-220-80).toFixed(0)+"px");
    s.style.setProperty("--rot",(Math.random()*260-130).toFixed(0)+"deg");
    s.style.animationDelay = (Math.random()*80) + "ms";
    card.appendChild(s);
  }
}

/* ---------- End Round ---------- */
function crossed(prevPct, nextPct, tick){ return prevPct < tick && nextPct >= tick; }

function endRound(){
  if(!players.length) return;

  pushUndoRound();
  if(!gameLocked) gameLocked=true;

  const target=Number($("targetPoints").value)||200;

  const prevTotals = players.map(p => p.total);
  const prevPct = players.map((p,i)=> Math.min((prevTotals[i]/target)*100, 100));
  const roundScores=[];

  players.forEach(p=>{
    const res = (p.override!==null) ? {score:p.override,isBust:(p.override===0)} : scoreFromCards(p.cards);
    const s=res.score;
    roundScores.push(s);

    p.total+=s;
    p.rounds.push(s);
    if(res.isBust) p.busts+=1;

    p.cards=[];
    p.override=null;
  });

  roundNumber += 1;

  const btn=$("endRoundBtn");
  btn.classList.add("saved");
  setTimeout(()=>btn.classList.remove("saved"), 420);

  renderAll();
  showRoundToast();

  players.forEach((p,i)=>{
    const nextTotal=p.total;
    const nextP = Math.min((nextTotal/target)*100, 100);
    const pc=$("pc_"+i);
    const pb=$("pb_"+i);

    // haptic only at 50% tick (optional, reduced noise)
    if(crossed(prevPct[i], nextP, 50)){
      pc?.classList.add("tick50");
      setTimeout(()=>pc?.classList.remove("tick50"), 220);
      vib(HAPT.sheetSnap); // reuse short tick
    }

    const totalEl=$("total_"+i);
    const leftEl=$("left_"+i);
    if(totalEl && leftEl){
      if(!reduceMotion()){
        const start=prevTotals[i], end=nextTotal, ms=380;
        const st=performance.now();
        function step(now){
          const t=Math.min((now-st)/ms,1);
          const eased=1-Math.pow(1-t,2);
          const val=Math.round(start+(end-start)*eased);
          totalEl.textContent=val;
          if(t<1) requestAnimationFrame(step);
          else leftEl.textContent = Math.max(target-end,0);
        }
        requestAnimationFrame(step);
      }else{
        totalEl.textContent=nextTotal;
        leftEl.textContent = Math.max(target-nextTotal,0);
      }
    }

    const deltaHost=$("delta_"+i);
    if(deltaHost){
      const s=roundScores[i];
      deltaHost.innerHTML="";
      const pill=document.createElement("span");
      pill.className="deltaPill"+(s===0 ? " bust": "");
      pill.textContent = (s===0) ? "0" : ("+"+s);
      deltaHost.appendChild(pill);
      setTimeout(()=>{ deltaHost.innerHTML=""; }, 800);
    }

    if(roundScores[i]===0){
      const row = document.querySelectorAll(".player-box")[i];

      row?.classList.add("bustAnim");
      setTimeout(()=>row?.classList.remove("bustAnim"), 300);

      if(row){
        const toast=document.createElement("div");
        toast.className="bustToast";
        toast.textContent="BUST";
        row.appendChild(toast);
        setTimeout(()=>toast.remove(), 520);
      }

      pc?.classList.add("bustRing","bustFlash");
      setTimeout(()=>pc?.classList.remove("bustRing","bustFlash"), 520);

      pb?.classList.add("resetBounce");
      setTimeout(()=>pb?.classList.remove("resetBounce"), 260);

      vib(HAPT.bust);
    }
  });

  save();

  const win = players.find(p=>p.total>=target);
  if(win){
    $("winnerText").textContent = win.name+" gewinnt!";
    $("winnerScreen").style.display="flex";
    spawnConfetti(players.find(x=>x.name===win.name)?.color || "#22c55e");
    vib(HAPT.win);
  }
}

/* ---------- Menu actions ---------- */
function redistributeColors(){
  if(!players.length) return;
  pushUndo();
  const pool=[...palette];
  for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
  players.forEach((p,i)=>p.color=pool[i%pool.length]);
  closeToolsMenu();
  renderAll(); save();
}
function undoAction(){
  if(!undoStack.length) return;
  closeToolsMenu();
  restore(undoStack.pop());
}
function undoRound(){
  if(!undoRoundStack.length) return;
  closeToolsMenu();
  hideRoundToast();
  restore(undoRoundStack.pop());
}
function newGame(){
  closeToolsMenu();
  const ok=confirm("Neues Spiel starten? (Alle Spieler werden entfernt)");
  if(!ok) return;
  players=[]; roundNumber=0; gameLocked=false;
  $("winnerScreen").style.display="none";
  $("rankingPanel").classList.remove("open");
  $("rankBtn").setAttribute("aria-expanded","false");
  editingIdx = null;
  save();
  renderAll();
  if(sheetOpen) renderSheetPlayers();
}

/* ---------- Wiring ---------- */
$("statsHead").addEventListener("click",()=>{
  statsOpen=!statsOpen;
  $("stats").style.display = statsOpen ? "block" : "none";
  $("statsChevron").textContent = statsOpen ? "â–²" : "â–¼";
  save();
});

$("colorsBtn").addEventListener("click",(e)=>{ e.preventDefault(); redistributeColors(); });
$("undoBtn").addEventListener("click",(e)=>{ e.preventDefault(); undoAction(); });
$("undoRoundBtn").addEventListener("click",(e)=>{ e.preventDefault(); undoRound(); });
$("newGameBtn").addEventListener("click",(e)=>{ e.preventDefault(); newGame(); });
$("sheetNewGameBtn").addEventListener("click",(e)=>{ e.preventDefault(); newGame(); });

$("toastUndoBtn").addEventListener("click",(e)=>{ e.preventDefault(); undoRound(); });
$("endRoundBtn").addEventListener("click",(e)=>{ e.preventDefault(); endRound(); });

$("targetPoints").addEventListener("change",()=>{
  if(gameLocked) return;
  save(); renderAll();
});

$("tabCards").addEventListener("click",(e)=>{ e.preventDefault(); setTab("cards"); });
$("tabDirect").addEventListener("click",(e)=>{ e.preventDefault(); setTab("direct"); });
$("applyFreeBtn").addEventListener("click",(e)=>{ e.preventDefault(); applyFree(); });
$("clearBtn").addEventListener("click",(e)=>{ e.preventDefault(); clearPopup(); });
$("cancelBtn").addEventListener("click",(e)=>{ e.preventDefault(); closePopup(true); });
$("finishBtn").addEventListener("click",(e)=>{ e.preventDefault(); closePopup(false); });
$("popupUndoBtn").addEventListener("click",(e)=>{ e.preventDefault(); popupUndoTap(); });

$("lastDirectChip").addEventListener("click",(e)=>{
  e.preventDefault();
  if(typeof lastDirectScore==="number"){
    $("freeScoreInput").value = lastDirectScore;
    applyFree();
  }
});

$("winnerNewGame").addEventListener("click",(e)=>{
  e.preventDefault();
  $("winnerScreen").style.display="none";
  newGame();
});

overlayEl.addEventListener("pointerdown",()=>closePopup(true),{passive:true});

/* Delegation: chip remove, open popup (+), tap Runde for Direktpunkte
   Long-press iOS-like: 320ms
*/
let pressTimer=null;
let longPressFired=false;

$("playersContainer").addEventListener("pointerdown",(e)=>{
  const rem = e.target.closest(".cardchip");
  if(rem && rem.dataset.rem!=null){
    const i=Number(rem.dataset.i);
    const ci=Number(rem.dataset.rem);

    rem.style.animation = "chipOut .12s ease forwards";
    setTimeout(()=>{
      pushUndo();
      players[i].cards.splice(ci,1);
      players[i].override=null;
      renderAll(); save();
    }, 120);
    return;
  }

  const directBtn = e.target.closest('button[data-direct="1"]');
  if(directBtn){
    e.preventDefault();
    const i=Number(directBtn.dataset.i);
    openPopup(i, true);
    return;
  }

  const plus=e.target.closest(".plusBtn");
  if(plus){
    e.preventDefault();
    const i=Number(plus.dataset.i);
    longPressFired=false;
    clearTimeout(pressTimer);
    pressTimer=setTimeout(()=>{
      longPressFired=true;
      openPopup(i, true);
    }, 320);
    plus.setPointerCapture?.(e.pointerId);
  }
},{passive:false});

$("playersContainer").addEventListener("pointerup",(e)=>{
  const plus=e.target.closest(".plusBtn");
  if(!plus) return;
  clearTimeout(pressTimer);
  if(!longPressFired){
    const i=Number(plus.dataset.i);
    openPopup(i, false);
  }
},{passive:false});

/* ---------- Utils ---------- */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ---------- Init ---------- */
function buildPopupGrids(){
  const ng=$("numberGrid");
  ng.innerHTML="";
  numbers.forEach(n=>{
    const b=document.createElement("button");
    b.type="button"; b.className="cardBtn";
    const st=numStyle[n]||{bg:"#eef1f5",fg:"#0b1220"};
    b.style.background=st.bg; b.style.color=st.fg||"#0b1220";
    b.textContent=String(n);
    b.addEventListener("pointerdown",(e)=>{e.preventDefault(); popupAdd(n);},{passive:false});
    ng.appendChild(b);
  });

  const mg=$("modGrid");
  mg.innerHTML="";
  ["+2","+4","+6","+8","+10","x2"].forEach(m=>{
    const b=document.createElement("button");
    b.type="button"; b.className="cardBtn modBtn"+(m==="x2"?" x2":"");
    b.textContent=m;
    b.addEventListener("pointerdown",(e)=>{e.preventDefault(); popupAdd(m);},{passive:false});
    mg.appendChild(b);
  });
}

buildPopupGrids();
load();
syncTogglesUI();
renderAll();

/* Default sheet list render if opened later */
renderSheetPlayers();
</script>
</body>
</html>
