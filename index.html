<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flip 7 – Score Tracker</title>

<style>
:root{
  --bg:#f6f7f9;
  --card:#ffffff;
  --muted:#eef1f5;
  --muted2:#e7e9ed;
  --text:#1a1a1a;
  --shadow:0 2px 6px rgba(0,0,0,.05);
  --shadow2:0 10px 25px rgba(0,0,0,.12);
  --radius:14px;
}

body{
  font-family:system-ui,Arial;
  background:var(--bg);
  margin:0;
  padding:14px;
  color:var(--text);
}

h1{ text-align:center; margin:8px 0 12px 0; font-size:1.35rem; }

/* Sticky Header: Leader + Ziel + Toggle */
#topbar{
  position:sticky;
  top:0;
  z-index:100;
  background:rgba(246,247,249,.92);
  backdrop-filter: blur(8px);
  padding:8px 0 10px 0;
}

#leaderStrip{
  background:var(--card);
  border-radius:16px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

#leaderLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
#leaderDot{ width:12px; height:12px; border-radius:50%; flex:0 0 auto; }
#leaderText{
  font-weight:800;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:62vw;
}
.badge{
  background:var(--muted);
  border-radius:999px;
  padding:6px 10px;
  font-weight:800;
  font-size:.9rem;
  white-space:nowrap;
}

.iconBtn{
  background:var(--muted);
  border:none;
  border-radius:12px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
}

#rankingPanel{
  margin-top:10px;
  background:var(--card);
  border-radius:16px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  padding:12px;
  display:none;
}
.rank-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:6px 0;
}
.rank-dot{ width:10px; height:10px; border-radius:50%; }

/* Add Player Row */
#addRow{
  display:flex;
  gap:8px;
  align-items:center;
  margin:10px 0 8px 0;
}
#playerName{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #d7dbe4;
  font-weight:700;
  outline:none;
}
.btnGreen{
  background:#22c55e;
  color:white;
  border:none;
  border-radius:12px;
  padding:10px 14px;
  font-weight:800;
  cursor:pointer;
}
.btnGhost{
  background:var(--muted);
  color:#111;
  border:none;
  border-radius:12px;
  padding:10px 14px;
  font-weight:800;
  cursor:pointer;
}
#targetRow{
  margin:10px 0 10px 0;
  background:var(--card);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:10px 12px;
  display:flex;
  align-items:center;
  gap:10px;
}
#targetPoints{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #d7dbe4;
  font-weight:800;
  outline:none;
}

/* Player list */
#playersContainer{ margin-top:10px; }

.player-box{
  background:var(--card);
  border-radius:16px;
  padding:12px;
  margin-bottom:10px;
  border-left:6px solid #ccc;
  box-shadow:var(--shadow);
  transition:.25s;
  position:relative;
}

.player-box.leader{ box-shadow:var(--shadow2); transform:scale(1.01); }
.player-box.pulse{ animation: leaderPulse 1.1s ease; }
@keyframes leaderPulse{
  0%{ box-shadow:var(--shadow); }
  50%{ box-shadow:0 0 0 6px rgba(34,197,94,.18), 0 18px 35px rgba(0,0,0,.14); }
  100%{ box-shadow:var(--shadow2); }
}
.player-box.bustFlash{ animation:bustFlash .7s ease; }
@keyframes bustFlash{ 0%{ background:#ffe3e3;} 100%{ background:var(--card);} }

.player-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.player-name{
  font-weight:900;
  font-size:1.02rem;
  display:flex;
  align-items:center;
  gap:8px;
  min-width:0;
}
.player-dot{ width:10px;height:10px;border-radius:50%;flex:0 0 auto; }
.player-mini{
  display:flex;
  align-items:center;
  gap:8px;
}
.miniBadge{
  background:var(--muted);
  border-radius:999px;
  padding:5px 8px;
  font-weight:900;
  font-size:.82rem;
}

.progress-container{
  background:var(--muted2);
  height:10px;
  border-radius:6px;
  overflow:hidden;
  margin:8px 0 6px 0;
}
.progress-bar{
  height:100%;
  transition:width .4s ease;
}

.player-line{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-weight:800;
}
.player-line .tapScore{
  background:transparent;
  border:none;
  padding:0;
  margin:0;
  font:inherit;
  cursor:pointer;
  text-decoration:underline;
  text-underline-offset:3px;
}
.sub{
  font-weight:800;
  color:#444;
  font-size:.92rem;
}

/* Smaller chips */
.card-container{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:8px;
}
.cardchip{
  background:var(--muted);
  padding:7px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:.9rem;
  cursor:pointer;
  user-select:none;
}

/* Add button icon */
.plusBtn{
  width:44px;
  height:44px;
  border-radius:14px;
  border:none;
  background:#1e88e5;
  color:white;
  font-weight:1000;
  font-size:22px;
  cursor:pointer;
  flex:0 0 auto;
}

.floatScore{
  position:absolute;
  right:14px;
  top:10px;
  font-weight:1000;
  font-size:1.02rem;
  opacity:0;
  animation:floatUp .9s ease forwards;
}
@keyframes floatUp{
  0%{opacity:0;transform:translateY(10px);}
  40%{opacity:1;}
  100%{opacity:0;transform:translateY(-26px);}
}

/* Bottom action bar */
#bottomBar{
  position:sticky;
  bottom:0;
  z-index:90;
  background:rgba(246,247,249,.92);
  backdrop-filter: blur(8px);
  padding:10px 0 0 0;
}
#bottomRow{
  display:flex;
  gap:8px;
}
#bottomRow button{
  flex:1;
  border:none;
  border-radius:14px;
  padding:14px 12px;
  font-weight:900;
  cursor:pointer;
}
#endRoundBtn{ background:#22c55e; color:white; }
#undoRoundBtn{ background:var(--muted); color:#111; }
#undoActionBtn{ background:var(--muted); color:#111; }

/* Stats collapsible */
#statsWrap{
  margin:12px 0 70px 0;
  background:var(--card);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:12px;
}
#statsHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  user-select:none;
}
#statsHead strong{ font-size:1.05rem; }
#stats{ display:none; margin-top:10px; color:#222; font-weight:800; line-height:1.55; }

/* Popup */
.overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  z-index:500;
}
.popup{
  display:none;
  position:fixed;
  top:6%;
  left:50%;
  transform:translateX(-50%);
  width:92%;
  max-width:560px;
  background:var(--card);
  padding:16px;
  border-radius:18px;
  max-height:88%;
  overflow:auto;
  z-index:1000;
}
.popupTitleRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.tabs{
  display:flex;
  gap:8px;
  margin:10px 0 8px 0;
}
.tab{
  flex:1;
  background:var(--muted);
  border:none;
  border-radius:12px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
}
.tab.active{
  background:#1e88e5;
  color:white;
}

.selectedWrap{
  background:var(--bg);
  border-radius:14px;
  padding:10px;
  margin:10px 0 10px 0;
}
.chips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.chip{
  background:white;
  border:1px solid #e2e6ee;
  border-radius:999px;
  padding:8px 10px;
  font-weight:900;
  cursor:pointer;
  user-select:none;
}
.hint{
  font-size:.92rem;
  font-weight:800;
  color:#444;
  margin-top:8px;
  padding:8px 10px;
  border-radius:12px;
  background:white;
  border:1px solid #eef1f5;
}
.hint.bust{
  background:#ffe3e3;
  border-color:#ffc3c3;
  color:#8a1f1f;
}
.hint.bonus{
  background:#e9ffe9;
  border-color:#c5f3c5;
  color:#145214;
}

.sectionTitle{
  margin:12px 0 8px 0;
  font-weight:1000;
}

.gridNumbers{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}
.gridMods{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
}
.cardBtn{
  background:var(--muted);
  border:none;
  border-radius:14px;
  padding:16px 0;
  font-weight:1000;
  font-size:1.05rem;
  cursor:pointer;
}
.cardBtn:active{ transform:scale(.98); }
.cardBtn.x2{
  grid-column:1/-1;
  background:#dff1ff;
}
.directRow{
  display:flex;
  gap:8px;
  align-items:center;
}
.directRow input{
  flex:1;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid #d7dbe4;
  font-weight:1000;
  outline:none;
  font-size:1.05rem;
}
.directRow button{
  border:none;
  border-radius:14px;
  padding:12px 14px;
  font-weight:1000;
  background:#22c55e;
  color:white;
  cursor:pointer;
  white-space:nowrap;
}

/* Sticky footer in popup */
.popupFooter{
  position:sticky;
  bottom:-16px;
  background:var(--card);
  padding:10px 0 0 0;
  margin-top:12px;
}
.popupFooterRow{
  display:flex;
  gap:8px;
}
.popupFooterRow button{
  flex:1;
  border:none;
  border-radius:14px;
  padding:14px 12px;
  font-weight:1000;
  cursor:pointer;
}
.footerGhost{ background:var(--muted); color:#111; }
.footerRed{ background:#ef4444; color:white; }
.footerBlue{ background:#1e88e5; color:white; }

/* Winner */
#winnerScreen{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  justify-content:center;
  align-items:center;
  z-index:2000;
}
#winnerCard{
  background:var(--card);
  padding:34px 26px;
  border-radius:24px;
  text-align:center;
  box-shadow:0 25px 60px rgba(0,0,0,.25);
}
</style>
</head>

<body>

<div id="topbar">
  <h1>Flip 7 – Score Tracker</h1>

  <div id="leaderStrip">
    <div id="leaderLeft">
      <div id="leaderDot"></div>
      <div id="leaderText">Noch keine Spieler</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div id="goalBadge" class="badge">Ziel: 200</div>
      <button class="iconBtn" onclick="toggleRanking()" aria-label="Ranking anzeigen">≡</button>
    </div>
  </div>

  <div id="rankingPanel"></div>
</div>

<div id="addRow">
  <input id="playerName" placeholder="Spielername" autocomplete="off">
  <button class="btnGreen" onclick="addPlayer()">+</button>
</div>

<div id="targetRow">
  <strong>Ziel</strong>
  <input type="number" id="targetPoints" value="200" inputmode="numeric" pattern="[0-9]*">
</div>

<div id="playersContainer"></div>

<div id="bottomBar">
  <div id="bottomRow">
    <button id="endRoundBtn" onclick="endRound()">Zwischenrunde beenden</button>
    <button id="undoActionBtn" onclick="undoAction()">Undo</button>
    <button id="undoRoundBtn" onclick="undoRound()">Undo Runde</button>
  </div>
</div>

<div id="statsWrap">
  <div id="statsHead" onclick="toggleStats()">
    <strong>Statistik</strong>
    <span id="statsChevron">▼</span>
  </div>
  <div id="stats"></div>
</div>

<div class="overlay" id="overlay" onclick="closePopup(true)"></div>

<div class="popup" id="popup">
  <div class="popupTitleRow">
    <h3 id="popupTitle" style="margin:0;">Karten</h3>
    <span id="popupPlayerBadge" class="badge"> </span>
  </div>

  <div class="tabs">
    <button id="tabCards" class="tab active" onclick="setTab('cards')">Karten</button>
    <button id="tabDirect" class="tab" onclick="setTab('direct')">Direktpunkte</button>
  </div>

  <div id="popupCardsView">
    <div class="selectedWrap">
      <div class="chips" id="selectedChips"></div>
      <div id="popupLiveInfo" class="hint"></div>
    </div>

    <div class="sectionTitle">Zahlen</div>
    <div id="numberGrid" class="gridNumbers"></div>

    <div class="sectionTitle">Modifier</div>
    <div id="modGrid" class="gridMods"></div>

    <div style="margin-top:10px; display:flex; justify-content:flex-end;">
      <button class="btnGhost" onclick="undoPopupPick()">Undo letzte Auswahl</button>
    </div>
  </div>

  <div id="popupDirectView" style="display:none;">
    <div class="selectedWrap">
      <div class="hint">Direktpunkte überschreiben die Karten dieser Runde (kein Bust/Bonus).</div>
    </div>
    <div class="directRow">
      <input id="freeScoreInput" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Punkte eingeben (z.B. 37)">
      <button onclick="applyFreeScore()">Übernehmen</button>
    </div>
  </div>

  <div class="popupFooter">
    <div class="popupFooterRow">
      <button class="footerGhost" onclick="clearPopupSelection()">Leeren</button>
      <button class="footerRed" onclick="closePopup(true)">Abbrechen</button>
      <button class="footerBlue" onclick="closePopup(false)">Fertig</button>
    </div>
  </div>
</div>

<div id="winnerScreen">
  <div id="winnerCard">
    <h2 id="winnerText" style="margin:0 0 16px 0;"></h2>
    <button class="btnGreen" onclick="resetGame()">Neues Spiel</button>
  </div>
</div>

<script>
/* ----------------- State ----------------- */
let players=[];
let selectedPlayer=null;

let gameLocked=false;
let prevLeaderIndex=null;

const palette=["#2563eb","#16a34a","#ea580c","#9333ea","#0ea5e9","#dc2626","#14b8a6","#eab308"];
const numbers=[...Array(13).keys()];
const modifiers=["+2","+4","+6","+8","+10","x2"];

let popupCards=[];
let popupManualOverride=null;
let popupHistory=[];

let actionStack=[];         // letzte Aktion
let lastRoundSnapshot=null; // Undo Runde

/* ----------------- Utils ----------------- */
function vib(ms){
  try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){}
}

function lockScroll(lock){
  document.body.style.overflow = lock ? "hidden" : "";
}

function saveState(){
  const state = {
    players, gameLocked,
    target: Number(targetPoints.value)||200,
    prevLeaderIndex
  };
  localStorage.setItem("flip7_tracker_state", JSON.stringify(state));
}

function loadState(){
  const raw = localStorage.getItem("flip7_tracker_state");
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    if(Array.isArray(s.players)) players = s.players;
    if(typeof s.gameLocked === "boolean") gameLocked = s.gameLocked;
    if(typeof s.target === "number") targetPoints.value = s.target;
    if(typeof s.prevLeaderIndex === "number") prevLeaderIndex = s.prevLeaderIndex;
  }catch(e){}
}

/* ----------------- Rules ----------------- */
function scoreFromCards(cards){
  const nums = cards.filter(c=>typeof c==="number");
  const mods = cards.filter(c=>typeof c==="string");

  const isBust = (nums.length===0) || (new Set(nums).size !== nums.length);
  if(isBust) return { score:0, isBust:true, numbersCount: nums.length };

  const sumNums = nums.reduce((a,b)=>a+b,0);

  // x2 nur auf Zahlen
  let multi = 1;
  for(const m of mods){
    if(m==="x2") multi *= 2;
  }

  // Modifier addieren
  let modSum = 0;
  for(const m of mods){
    if(m.startsWith("+")) modSum += Number(m.slice(1));
  }

  const bonus = (nums.length===7) ? 15 : 0;

  const score = (sumNums * multi) + modSum + bonus;
  return { score, isBust:false, numbersCount: nums.length };
}

/* ----------------- UI Build popup grids ----------------- */
function buildPopupGrids(){
  numberGrid.innerHTML = "";
  numbers.forEach(n=>{
    const b=document.createElement("button");
    b.className="cardBtn";
    b.textContent=String(n);
    b.onclick=()=>popupAdd(n);
    numberGrid.appendChild(b);
  });

  modGrid.innerHTML = "";
  // 2 Reihen große Buttons + x2 separat groß
  const modOrder = ["+2","+4","+6","+8","+10","x2"];
  modOrder.forEach(m=>{
    const b=document.createElement("button");
    b.className="cardBtn" + (m==="x2" ? " x2" : "");
    b.textContent=m;
    b.onclick=()=>popupAdd(m);
    modGrid.appendChild(b);
  });
}

/* ----------------- Ranking Panel ----------------- */
function toggleRanking(){
  const isOpen = rankingPanel.style.display === "block";
  rankingPanel.style.display = isOpen ? "none" : "block";
}

function renderRankingPanel(){
  const target = Number(targetPoints.value)||200;
  const list = [...players].map(p=>{
    const live = (p.overrideScore !== null) ? p.overrideScore : scoreFromCards(p.cards).score;
    return { name:p.name, color:p.color, score:p.total + live };
  }).sort((a,b)=>b.score-a.score);

  rankingPanel.innerHTML = list.length ? list.map((p,i)=>`
    <div class="rank-row">
      ${i+1}.
      <span class="rank-dot" style="background:${p.color}"></span>
      <span style="font-weight:900;">${p.name}</span>
      <span style="margin-left:auto;font-weight:900;">${p.score}</span>
    </div>
  `).join("") : `<div style="font-weight:800;color:#555;">Noch keine Spieler</div>`;

  // Sticky strip content
  if(list.length){
    const leader = list[0];
    leaderDot.style.background = leader.color;
    leaderText.textContent = `${leader.name} führt (${leader.score})`;
  }else{
    leaderDot.style.background = "#cbd5e1";
    leaderText.textContent = "Noch keine Spieler";
  }
  goalBadge.textContent = `Ziel: ${target}`;
}

/* ----------------- Players ----------------- */
function addPlayer(){
  const name = playerName.value.trim();
  if(!name) return;

  players.push({
    name,
    color: palette[players.length % palette.length],
    cards:[],
    total:0,
    rounds:[],
    busts:0,
    lastScore:null,
    lastBust:false,
    overrideScore:null
  });

  actionStack.push({ type:"addPlayer", name });
  playerName.value="";
  renderAll();
  saveState();
}

function removeCard(playerIndex, cardIndex){
  const p = players[playerIndex];
  const removed = p.cards.splice(cardIndex,1)[0];
  p.overrideScore = null;
  actionStack.push({ type:"removeCard", playerIndex, removed });
  renderAll();
  saveState();
}

/* ----------------- Popup ----------------- */
let popupTab = "cards";

function setTab(t){
  popupTab = t;
  tabCards.classList.toggle("active", t==="cards");
  tabDirect.classList.toggle("active", t==="direct");
  popupCardsView.style.display = (t==="cards") ? "block" : "none";
  popupDirectView.style.display = (t==="direct") ? "block" : "none";

  if(t==="direct"){
    setTimeout(()=>freeScoreInput.focus(), 60);
  }
}

function openPopup(i, startDirect=false){
  selectedPlayer=i;
  popupCards = [...players[i].cards];
  popupManualOverride = players[i].overrideScore;
  popupHistory = [];

  popup.style.display="block";
  overlay.style.display="block";
  lockScroll(true);

  popupTitle.textContent = startDirect ? "Direktpunkte" : "Karten";
  popupPlayerBadge.textContent = players[i].name;

  freeScoreInput.value = popupManualOverride !== null ? popupManualOverride : "";
  renderPopupSelection();

  setTab(startDirect ? "direct" : "cards");
}

function closePopup(cancel){
  popup.style.display="none";
  overlay.style.display="none";
  lockScroll(false);

  if(!cancel && selectedPlayer!==null){
    const p = players[selectedPlayer];
    // Save old for undo action
    const before = { cards:[...p.cards], overrideScore:p.overrideScore };

    p.cards = [...popupCards];
    p.overrideScore = popupManualOverride;

    actionStack.push({ type:"popupApply", playerIndex:selectedPlayer, before });
    vib(20); // "Fertig"
    saveState();
  }

  selectedPlayer=null;
  renderAll();
}

function popupAdd(card){
  popupHistory.push({ kind:"add", card });
  popupCards.push(card);
  popupManualOverride = null;
  freeScoreInput.value="";
  renderPopupSelection();
  vib(12); // add
}

function popupRemoveAt(index){
  const removed = popupCards.splice(index,1)[0];
  popupHistory.push({ kind:"remove", card:removed, index });
  popupManualOverride = null;
  freeScoreInput.value="";
  renderPopupSelection();
  vib(10); // remove
}

function undoPopupPick(){
  const last = popupHistory.pop();
  if(!last) return;
  if(last.kind==="add"){
    popupCards.pop();
  }else if(last.kind==="remove"){
    popupCards.splice(last.index,0,last.card);
  }
  popupManualOverride = null;
  freeScoreInput.value="";
  renderPopupSelection();
}

function clearPopupSelection(){
  popupHistory.push({ kind:"clear", prevCards:[...popupCards], prevOverride:popupManualOverride });
  popupCards = [];
  popupManualOverride = null;
  freeScoreInput.value="";
  renderPopupSelection();
}

function applyFreeScore(){
  const val = Number(freeScoreInput.value);
  if(!Number.isFinite(val) || val < 0) return;
  popupManualOverride = Math.floor(val);
  renderPopupSelection();
}

function renderPopupSelection(){
  selectedChips.innerHTML = "";

  if(popupCards.length===0){
    selectedChips.innerHTML = `<span style="font-weight:900;color:#555;">Keine Karten ausgewählt.</span>`;
  }else{
    popupCards.forEach((c, idx)=>{
      const chip=document.createElement("div");
      chip.className="chip";
      chip.textContent=String(c);
      chip.title="Entfernen";
      chip.onclick=()=>popupRemoveAt(idx);
      selectedChips.appendChild(chip);
    });
  }

  if(popupManualOverride !== null){
    popupLiveInfo.className="hint";
    popupLiveInfo.textContent = `Vorschau: ${popupManualOverride} Punkte (manuell)`;
    return;
  }

  const preview = scoreFromCards(popupCards);
  if(popupCards.length===0){
    popupLiveInfo.className="hint";
    popupLiveInfo.textContent = "Vorschau: –";
    return;
  }

  if(preview.isBust){
    popupLiveInfo.className="hint bust";
    popupLiveInfo.textContent = "Vorschau: BUST (0 Punkte)";
  }else{
    const isBonus = preview.numbersCount===7;
    popupLiveInfo.className = "hint" + (isBonus ? " bonus" : "");
    popupLiveInfo.textContent = `Vorschau: ${preview.score} Punkte` + (isBonus ? " • +15 Bonus" : "");
  }
}

/* ----------------- Compact Player Cards ----------------- */
function renderPlayers(){
  playersContainer.innerHTML="";
  const target = Number(targetPoints.value)||200;

  const leader = getLeader();
  const leaderChanged = (prevLeaderIndex !== null && leader !== prevLeaderIndex);
  prevLeaderIndex = leader;

  players.forEach((p,i)=>{
    const res = (p.overrideScore !== null)
      ? { score:p.overrideScore, isBust:(p.overrideScore===0), numbersCount:0 }
      : scoreFromCards(p.cards);

    const live = res.score;
    const total = p.total + live;

    const div=document.createElement("div");
    div.className="player-box";
    if(i===leader) div.classList.add("leader");
    div.style.borderLeftColor = p.color;

    if(i===leader && leaderChanged){
      div.classList.add("pulse");
      setTimeout(()=>div.classList.remove("pulse"), 1200);
    }

    if(p.lastScore !== null && p.lastBust){
      div.classList.add("bustFlash");
      setTimeout(()=>div.classList.remove("bustFlash"), 750);
    }

    const floatText = (p.lastScore===null)
      ? ""
      : `<div class="floatScore">${p.lastBust ? "BUST" : "+"+p.lastScore}</div>`;

    // Hint nur wenn Karten da sind
    let hint = "";
    if(p.cards.length > 0){
      hint = res.isBust
        ? `<span class="miniBadge" style="background:#ffe3e3;color:#8a1f1f;">BUST</span>`
        : (res.numbersCount===7 ? `<span class="miniBadge" style="background:#e9ffe9;color:#145214;">+15</span>` : "");
    }

    const overrideHint = (p.overrideScore !== null)
      ? `<span class="miniBadge">manuell</span>`
      : "";

    const cardsHTML = p.cards.map((c, idx)=>`
      <span class="cardchip" onclick="removeCard(${i},${idx})">${c}</span>
    `).join("");

    div.innerHTML = `
      <div class="player-top">
        <div class="player-name">
          <span class="player-dot" style="background:${p.color}"></span>
          <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.name}</span>
          ${hint} ${overrideHint}
        </div>
        <div class="player-mini">
          <button class="plusBtn" onclick="openPopup(${i}, false)" aria-label="Karte hinzufügen">+</button>
        </div>
      </div>

      ${floatText}

      <div class="progress-container">
        <div class="progress-bar" style="width:${Math.min((target ? (total/target*100) : 0), 100)}%; background:${p.color}"></div>
      </div>

      <div class="player-line">
        <span class="sub">Runde: <button class="tapScore" onclick="openPopup(${i}, true)">${live}</button></span>
        <span>Gesamt: ${total}</span>
      </div>

      ${p.cards.length ? `<div class="card-container">${cardsHTML}</div>` : ``}
    `;

    playersContainer.appendChild(div);
  });
}

function getLeader(){
  let best=-1,score=-Infinity;
  players.forEach((p,i)=>{
    const live = (p.overrideScore !== null) ? p.overrideScore : scoreFromCards(p.cards).score;
    const s = p.total + live;
    if(s>score){score=s;best=i;}
  });
  return best;
}

/* ----------------- Stats ----------------- */
let statsOpen=false;
function toggleStats(){
  statsOpen = !statsOpen;
  stats.style.display = statsOpen ? "block" : "none";
  statsChevron.textContent = statsOpen ? "▲" : "▼";
}

function renderStats(){
  let html="";
  players.forEach(p=>{
    const avg = (p.rounds.reduce((a,b)=>a+b,0) / (p.rounds.length||1)).toFixed(1);
    const bustQuote = p.rounds.length ? Math.round((p.busts/p.rounds.length)*100) : 0;
    html += `<div style="margin:6px 0;">
      <span style="font-weight:1000;">${p.name}</span>:
      Ø ${avg} • Bust ${bustQuote}% (${p.busts}/${p.rounds.length})
    </div>`;
  });
  stats.innerHTML = html || `<div style="font-weight:900;color:#555;">Noch keine Daten</div>`;
}

/* ----------------- Round / Undo ----------------- */
function endRound(){
  const target = Number(targetPoints.value)||200;

  // Snapshot for Undo Runde
  lastRoundSnapshot = JSON.parse(JSON.stringify(players));

  if(!gameLocked){
    gameLocked=true;
    targetRow.style.display="none";
  }

  players.forEach(p=>{
    let res;
    if(p.overrideScore !== null){
      res = { score:p.overrideScore, isBust:(p.overrideScore===0) };
    }else{
      res = scoreFromCards(p.cards);
    }

    const s=res.score;
    p.total += s;
    p.rounds.push(s);
    p.lastScore = s;
    p.lastBust = res.isBust;
    if(res.isBust) p.busts += 1;

    p.cards = [];
    p.overrideScore = null;
  });

  const win = players.find(p=>p.total >= target);

  renderAll();
  saveState();

  // Bust vibration only when Bust happens
  if(players.some(p=>p.lastBust)) vib(25);

  setTimeout(()=>{
    players.forEach(p=>{ p.lastScore=null; p.lastBust=false; });
    renderPlayers();
  }, 1000);

  if(win) showWinner(win.name);
}

function undoRound(){
  if(!lastRoundSnapshot) return;
  players = JSON.parse(JSON.stringify(lastRoundSnapshot));
  lastRoundSnapshot = null;
  actionStack.push({ type:"undoRound" });
  renderAll();
  saveState();
}

function undoAction(){
  const a = actionStack.pop();
  if(!a) return;

  if(a.type==="addPlayer"){
    const idx = players.findIndex(p=>p.name===a.name);
    if(idx>=0) players.splice(idx,1);
  }else if(a.type==="removeCard"){
    const p = players[a.playerIndex];
    if(p) p.cards.push(a.removed);
  }else if(a.type==="popupApply"){
    const p = players[a.playerIndex];
    if(p){
      p.cards = [...a.before.cards];
      p.overrideScore = a.before.overrideScore;
    }
  }
  renderAll();
  saveState();
}

/* ----------------- Winner / Reset ----------------- */
function showWinner(name){
  winnerText.textContent = name+" gewinnt!";
  winnerScreen.style.display="flex";
}
function resetGame(){
  const ok = confirm("Wirklich neues Spiel starten? (Alles wird zurückgesetzt)");
  if(!ok) return;

  winnerScreen.style.display="none";
  players.forEach(p=>{
    p.total=0;
    p.cards=[];
    p.rounds=[];
    p.busts=0;
    p.lastScore=null;
    p.lastBust=false;
    p.overrideScore=null;
  });
  gameLocked=false;
  targetRow.style.display="flex";
  lastRoundSnapshot=null;
  actionStack=[];
  renderAll();
  saveState();
}

/* ----------------- Render ----------------- */
function renderAll(){
  // Goal display
  const target = Number(targetPoints.value)||200;
  goalBadge.textContent = `Ziel: ${target}`;

  // lock target after start
  if(gameLocked) targetRow.style.display="none";

  renderRankingPanel();
  renderPlayers();
  renderStats();
}

/* ----------------- Init ----------------- */
loadState();
buildPopupGrids();

// target changes should persist only if not locked
targetPoints.addEventListener("change", ()=>{
  if(gameLocked) return;
  saveState();
  renderAll();
});

renderAll();
</script>
</body>
</html>
